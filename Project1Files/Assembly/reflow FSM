
dseg: 

reflow_state: ds 1
pwm: ds 1
temp: ds 1
sec: ds 1 		; seconds variable for reflow FSM (to be incremented every second)
cooled_temp: ds 1

; State 0 - menu
; 1 - ramp to soak 
; 2- Soak
; 3- Ramp to reflow
; 4- Reflow
; 5- Cooling 
; 

reflow_state_machine: 

	mov a, reflow_state

	state0:
			cjne a, #0, state1
			mov pwm, #0
			jb MASTER_START_STOP, state0_done
			jnb MASTER_START_STOP, $ ; Wait for key release
			mov state, #1
		state0_done:
			ljmp forever


	state1:
			cjne a, #1, state2
			mov pwm, #100		; Heater on at 100% duty
			mov sec, #0
			mov a, soaktemp
			clr c
			subb a, temp
			jnc state1_done 	;if temp>soaktemp then go to state 2 
			mov sec, #0			; Reset time 'sec' variable representing elapsed time in each state
			mov state, #2
		state1_done:
			ljmp forever

	state2:
			cjne a, #2, state3
			mov pwm, #20		;20% duty
			mov a, soaktime
			clr c
			subb a, sec
			jnc state2_done
			mov state, #3
			mov sec, #0			; reset time for state 3
		state2_done:
			ljmp forever

	state3:
			cjne a, #3, state4
			mov pwm, #100		; Heater on at 100% duty
			mov a, reflowtemp
			clr c
			subb a, temp
			jnc state3_done 	;if temp>reflowtemp then go to state 4
			mov sec, #0			; reset time for state 4
			mov state, #4
		state3_done:
			ljmp forever

	state4:
			cjne a, #4, state5
			mov pwm, #20		;20% duty
			mov a, reflowtime
			clr c
			subb a, sec
			jnc state4_done
			mov state, #5
			mov sec, #0		; reset time for state 5
		state4_done:
			ljmp forever

	state5:
			cjne a, #5, state0
			mov pwm, #0			; Heater on at 100% duty
			mov a, cooled_temp
			clr c
			subb a, temp
			jnc state5_done 	;if temp>reflowtemp then go to state 4
			mov sec, #0			; reset time for state 4
			mov state, #0
		state5_done:
			ljmp forever