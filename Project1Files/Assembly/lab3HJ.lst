                 -1   $MODLP51
0000              1   ;--------------------------------------------------------
0000              2   ; Special Function Registers
0000              3   ;--------------------------------------------------------
0000              4   ACC            DATA 0xe0
0000              5   B              DATA 0xf0
0000              6   PSW            DATA 0xd0
0000              7   SP             DATA 0x81
0000              8   SPX            DATA 0xef
0000              9   DPL            DATA 0x82
0000             10   DPH            DATA 0x83
0000             11   DPLB           DATA 0xd4
0000             12   DPHB           DATA 0xd5
0000             13   PAGE           DATA 0xf6
0000             14   AX             DATA 0xe1
0000             15   BX             DATA 0xf7
0000             16   DSPR           DATA 0xe2
0000             17   FIRD           DATA 0xe3
0000             18   MACL           DATA 0xe4
0000             19   MACH           DATA 0xe5
0000             20   PCON           DATA 0x87
0000             21   AUXR           DATA 0x8e
0000             22   AUXR1          DATA 0xa2
0000             23   DPCF           DATA 0xa1
0000             24   CKRL           DATA 0x97
0000             25   CKCKON0        DATA 0x8f
0000             26   CKCKON1        DATA 0xaf
0000             27   CKSEL          DATA 0x85
0000             28   CLKREG         DATA 0xae
0000             29   OSCCON         DATA 0x85
0000             30   IE             DATA 0xa8
0000             31   IEN0           DATA 0xa8
0000             32   IEN1           DATA 0xb1
0000             33   IPH0           DATA 0xb7
0000             34   IP             DATA 0xb8
0000             35   IPL0           DATA 0xb8
0000             36   IPH1           DATA 0xb3
0000             37   IPL1           DATA 0xb2
0000             38   P0             DATA 0x80
0000             39   P1             DATA 0x90
0000             40   P2             DATA 0xa0
0000             41   P3             DATA 0xb0
0000             42   P4             DATA 0xc0
0000             43   P0M0           DATA 0xe6
0000             44   P0M1           DATA 0xe7
0000             45   P1M0           DATA 0xd6
0000             46   P1M1           DATA 0xd7
0000             47   P2M0           DATA 0xce
0000             48   P2M1           DATA 0xcf
0000             49   P3M0           DATA 0xc6
0000             50   P3M1           DATA 0xc7
0000             51   P4M0           DATA 0xbe
0000             52   P4M1           DATA 0xbf
0000             53   SCON           DATA 0x98
0000             54   SBUF           DATA 0x99
0000             55   SADEN          DATA 0xb9
0000             56   SADDR          DATA 0xa9
0000             57   BDRCON         DATA 0x9b
0000             58   BRL            DATA 0x9a
0000             59   TCON           DATA 0x88
0000             60   TMOD           DATA 0x89
0000             61   TCONB          DATA 0x91
0000             62   TL0            DATA 0x8a
0000             63   TH0            DATA 0x8c
0000             64   TL1            DATA 0x8b
0000             65   TH1            DATA 0x8d
0000             66   RL0            DATA 0xf2
0000             67   RL1            DATA 0xf3
0000             68   RH0            DATA 0xf4
0000             69   RH1            DATA 0xf5
0000             70   WDTRST         DATA 0xa6
0000             71   WDTPRG         DATA 0xa7
0000             72   T2CON          DATA 0xc8
0000             73   T2MOD          DATA 0xc9
0000             74   RCAP2H         DATA 0xcb
0000             75   RCAP2L         DATA 0xca
0000             76   TH2            DATA 0xcd
0000             77   TL2            DATA 0xcc
0000             78   SPCON          DATA 0xc3
0000             79   SPSTA          DATA 0xc4
0000             80   SPDAT          DATA 0xc5
0000             81   SSCON          DATA 0x93
0000             82   SSCS           DATA 0x94
0000             83   SSDAT          DATA 0x95
0000             84   SSADR          DATA 0x96
0000             85   KBLS           DATA 0x9c
0000             86   KBE            DATA 0x9d
0000             87   KBF            DATA 0x9e
0000             88   KBMOD          DATA 0x9f
0000             89   BMSEL          DATA 0x92
0000             90   FCON           DATA 0xd2
0000             91   EECON          DATA 0xd2
0000             92   ACSRA          DATA 0xa3
0000             93   ACSRB          DATA 0xab
0000             94   AREF           DATA 0xbd
0000             95   DADC           DATA 0xa4
0000             96   DADI           DATA 0xa5
0000             97   DADL           DATA 0xac
0000             98   DADH           DATA 0xad
0000             99   CCON           DATA 0xd8
0000            100   CMOD           DATA 0xd9
0000            101   CL             DATA 0xe9
0000            102   CH             DATA 0xf9
0000            103   CCAPM0         DATA 0xda
0000            104   CCAPM1         DATA 0xdb
0000            105   CCAPM2         DATA 0xdc
0000            106   CCAPM3         DATA 0xdd
0000            107   CCAPM4         DATA 0xde
0000            108   CCAP0H         DATA 0xfa
0000            109   CCAP1H         DATA 0xfb
0000            110   CCAP2H         DATA 0xfc
0000            111   CCAP3H         DATA 0xfd
0000            112   CCAP4H         DATA 0xfe
0000            113   CCAP0L         DATA 0xea
0000            114   CCAP1L         DATA 0xeb
0000            115   CCAP2L         DATA 0xec
0000            116   CCAP3L         DATA 0xed
0000            117   CCAP4L         DATA 0xee
0000            118   ;--------------------------------------------------------
0000            119   ; special function bits
0000            120   ;--------------------------------------------------------
0000            121   P              BIT 0xd0
0000            122   F1             BIT 0xd1
0000            123   OV             BIT 0xd2
0000            124   RS0            BIT 0xd3
0000            125   RS1            BIT 0xd4
0000            126   F0             BIT 0xd5
0000            127   AC             BIT 0xd6
0000            128   CY             BIT 0xd7
0000            129   EX0            BIT 0xa8
0000            130   ET0            BIT 0xa9
0000            131   EX1            BIT 0xaa
0000            132   ET1            BIT 0xab
0000            133   ES             BIT 0xac
0000            134   ET2            BIT 0xad
0000            135   EC             BIT 0xae
0000            136   EA             BIT 0xaf
0000            137   PX0            BIT 0xb8
0000            138   PT0            BIT 0xb9
0000            139   PX1            BIT 0xba
0000            140   PT1            BIT 0xbb
0000            141   PS             BIT 0xbc
0000            142   PT2            BIT 0xbd
0000            143   IP0D           BIT 0xbf
0000            144   PPCL           BIT 0xbe
0000            145   PT2L           BIT 0xbd
0000            146   PLS            BIT 0xbc
0000            147   PT1L           BIT 0xbb
0000            148   PX1L           BIT 0xba
0000            149   PT0L           BIT 0xb9
0000            150   PX0L           BIT 0xb8
0000            151   RXD            BIT 0xb0
0000            152   TXD            BIT 0xb1
0000            153   INT0           BIT 0xb2
0000            154   INT1           BIT 0xb3
0000            155   T0             BIT 0xb4
0000            156   T1             BIT 0xb5
0000            157   WR             BIT 0xb6
0000            158   RD             BIT 0xb7
0000            159   RI             BIT 0x98
0000            160   TI             BIT 0x99
0000            161   RB8            BIT 0x9a
0000            162   TB8            BIT 0x9b
0000            163   REN            BIT 0x9c
0000            164   SM2            BIT 0x9d
0000            165   SM1            BIT 0x9e
0000            166   SM0            BIT 0x9f
0000            167   IT0            BIT 0x88
0000            168   IE0            BIT 0x89
0000            169   IT1            BIT 0x8a
0000            170   IE1            BIT 0x8b
0000            171   TR0            BIT 0x8c
0000            172   TF0            BIT 0x8d
0000            173   TR1            BIT 0x8e
0000            174   TF1            BIT 0x8f
0000            175   CP_RL2         BIT 0xc8
0000            176   C_T2           BIT 0xc9
0000            177   TR2            BIT 0xca
0000            178   EXEN2          BIT 0xcb
0000            179   TCLK           BIT 0xcc
0000            180   RCLK           BIT 0xcd
0000            181   EXF2           BIT 0xce
0000            182   TF2            BIT 0xcf
0000            183   CF             BIT 0xdf
0000            184   CR             BIT 0xde
0000            185   CCF4           BIT 0xdc
0000            186   CCF3           BIT 0xdb
0000            187   CCF2           BIT 0xda
0000            188   CCF1           BIT 0xd9
0000            189   CCF0           BIT 0xd8
0000              2   
0000              3   ; There is a couple of typos in MODLP51 in the definition of the timer 0/1 reload
0000              4   ; special function registers (SFRs), so:
0000              5   
0000              6   TIMER0_RELOAD_L DATA 0xf2
0000              7   TIMER1_RELOAD_L DATA 0xf3
0000              8   TIMER0_RELOAD_H DATA 0xf4
0000              9   TIMER1_RELOAD_H DATA 0xf5
0000             10   
0000             11   CLK           EQU 22118400 ; Microcontroller system crystal frequency in Hz
0000             12   TIMER0_RATE   EQU 4096     ; 2048Hz squarewave (peak amplitude of CEM-1203 speaker)
0000             13   TIMER0_RELOAD EQU ((65536-(CLK/TIMER0_RATE)))
0000             14   TIMER2_RATE   EQU 1000     ; 1000Hz, for a timer tick of 1ms
0000             15   TIMER2_RELOAD EQU ((65536-(CLK/TIMER2_RATE)))
0000             16   
0000             17   org 0x0000
0000 020696      18      ljmp MainProgram
0003             19   
0003             20   ; External interrupt 0 vector (not used in this code)
0003             21   org 0x0003
0003 32          22            reti
0004             23   
0004             24   ; Timer/Counter 0 overflow interrupt vector
000B             25   org 0x000B
000B 020365      26            ljmp Timer0_ISR
000E             27   
000E             28   ; External interrupt 1 vector (not used in this code)
0013             29   org 0x0013
0013 32          30            reti
0014             31   
0014             32   ; Timer/Counter 1 overflow interrupt vector (not used in this code)
001B             33   org 0x001B
001B 32          34            reti
001C             35   
001C             36   ; Serial port receive/transmit interrupt vector (not used in this code)
0023             37   org 0x0023 
0023 32          38            reti
0024             39            
0024             40   ; Timer/Counter 2 overflow interrupt vector
002B             41   org 0x002B
002B 020381      42            ljmp Timer2_ISR
002E             43   
002E             44   BAUD equ 115200
002E             45   BRG_VAL equ (0x100-(CLK/(16*BAUD)))
002E             46   
002E             47   ; These ’EQU’ must match the wiring between the microcontroller and ADC
002E             48   SOUND_OUT   EQU P3.7
002E             49   CE_ADC EQU P2.0
002E             50   MY_MOSI EQU P2.1
002E             51   MY_MISO EQU P2.2
002E             52   MY_SCLK EQU P2.3
002E             53   
0030             54   DSEG at 0x30
0030             55   Count1ms:      ds 2 ; Used to determine when half second has passed
0032             56   Result:        ds 2
0034             57   Result_Thermo: ds 2
0036             58   x:             ds 4
003A             59   y:             ds 4
003E             60   bcd:           ds 5
0043             61   
0000             62   BSEG
0000             63   mf: dbit 1
0001             64   
                546   $LIST
                 66   $LIST
029E             68   
029E             69   CSEG
029E             70   LCD_RS equ P1.1
029E             71   LCD_RW equ P1.2
029E             72   LCD_E  equ P1.3
029E             73   LCD_D4 equ P3.2
029E             74   LCD_D5 equ P3.3
029E             75   LCD_D6 equ P3.4
029E             76   LCD_D7 equ P3.5
029E             77   
                 79   	$LIST
034C             81   
034C             82   ;---------------------------------;
034C             83   ; Routine to initialize the ISR   ;
034C             84   ; for timer 0                     ;
034C             85   ;---------------------------------;
034C             86   Timer0_Init:
034C E589        87            mov a, TMOD
034E 54F0        88            anl a, #0xf0 ; Clear the bits for timer 0
0350 4401        89            orl a, #0x01 ; Configure timer 0 as 16-timer
0352 F589        90            mov TMOD, a
0354 758CEA      91            mov TH0, #high(TIMER0_RELOAD)
0357 758AE8      92            mov TL0, #low(TIMER0_RELOAD)
035A             93            ; Set autoreload value
035A 75F4EA      94            mov TIMER0_RELOAD_H, #high(TIMER0_RELOAD)
035D 75F2E8      95            mov TIMER0_RELOAD_L, #low(TIMER0_RELOAD)
0360             96            ; Enable the timer and interrupts
0360 D2A9        97       setb ET0  ; Enable timer 0 interrupt
0362 D28C        98       setb TR0  ; Start timer 0
0364 22          99            ret
0365            100   
0365            101   ;---------------------------------;
0365            102   ; ISR for timer 0.  Set to execute;
0365            103   ; every 1/4096Hz to generate a    ;
0365            104   ; 2048 Hz square wave at pin P3.7 ;
0365            105   ;---------------------------------;
0365            106   Timer0_ISR:
0365            107            ;clr TF0  ; According to the data sheet this is done for us already.
0365 8000       108            sjmp no_beep
0367            109   beep_on:
0367            110            ;cpl SOUND_OUT ; Connect speaker to P3.7!
0367            111   no_beep:
0367 32         112            reti
0368            113   
                114   Send_BCD mac
                115   	push ar0
                116   	mov r0, %0
                117   	lcall ?Send_BCD
                118   	mov a, #'\r'
                119       lcall putchar
                120       mov a, #'\n'
                121       lcall putchar
                122   	pop ar0
                123   endmac
0368            124   ;---------------------------------;
0368            125   ; Routine to initialize the ISR   ;
0368            126   ; for timer 2                     ;
0368            127   ;---------------------------------;
0368            128   Timer2_Init:
0368 75C800     129            mov T2CON, #0 ; Stop timer/counter.  Autoreload mode.
036B 75CDA9     130            mov TH2, #high(TIMER2_RELOAD)
036E 75CC9A     131            mov TL2, #low(TIMER2_RELOAD)
0371            132            ; Set the reload value
0371 75CBA9     133            mov RCAP2H, #high(TIMER2_RELOAD)
0374 75CA9A     134            mov RCAP2L, #low(TIMER2_RELOAD)
0377            135            ; Init One millisecond interrupt counter.  It is a 16-bit variable made with two 8-bit parts
0377 E4         136            clr a
0378 F530       137            mov Count1ms+0, a
037A F531       138            mov Count1ms+1, a
037C            139            ; Enable the timer and interrupts
037C D2AD       140       setb ET2  ; Enable timer 2 interrupt
037E D2CA       141       setb TR2  ; Enable timer 2
0380 22         142            ret
0381            143   
0381            144   ;---------------------------------;
0381            145   ; ISR for timer 2                 ;
0381            146   ;---------------------------------;
0381            147   Timer2_ISR:
0381 C2CF       148            clr TF2  ; Timer 2 doesn't clear TF2 automatically. Do it in ISR
0383 B2B6       149            cpl P3.6 ; To check the interrupt rate with oscilloscope. It must be precisely a 1 ms pulse.
0385            150            
0385            151            ; The two registers used in the ISR must be saved in the stack
0385 C0E0       152            push acc
0387 C0D0       153            push psw
0389            154            
0389            155            ; Increment the 16-bit one mili second counter
0389 0530       156            inc Count1ms+0    ; Increment the low 8-bits first
038B E530       157            mov a, Count1ms+0
038D B41016     158            cjne a, #10h, Timer2_ISR_done
0390 753000     159            mov Count1ms+0, #0h
0393 C000       160            push ar0
0395 A83E       160            mov r0, bcd
0397 1205D9     160            lcall ?Send_BCD
039A 740D       160            mov a, #'\r'
039C 1203C3     160       lcall putchar
039F 740A       160       mov a, #'\n'
03A1 1203C3     160       lcall putchar
03A4 D000       160            pop ar0
03A6            161            
03A6            162   Timer2_ISR_done:
03A6 D0D0       163            pop psw
03A8 D0E0       164            pop acc
03AA 32         165            reti
03AB            166   
03AB            167   ; Configure the serial port and baud rate
03AB            168   InitSerialPort:
03AB            169       ; Since the reset button bounces, we need to wait a bit before
03AB            170       ; sending messages, otherwise we risk displaying gibberish!
03AB 79DE       171       mov R1, #222
03AD 78A6       172       mov R0, #166
03AF D8FE       173       djnz R0, $   ; 3 cycles->3*45.21123ns*166=22.51519us
03B1 D9FA       174       djnz R1, $-4 ; 22.51519us*222=4.998ms
03B3            175       ; Now we can proceed with the configuration
03B3 438780     176            orl     PCON,#0x80
03B6 759852     177            mov     SCON,#0x52
03B9 759B00     178            mov     BDRCON,#0x00
03BC 759AF4     179            mov     BRL,#BRG_VAL
03BF 759B1E     180            mov     BDRCON,#0x1E ; BDRCON=BRR|TBCK|RBCK|SPD;
03C2 22         181       ret
03C3            182   
03C3            183   ; Send a character using the serial port
03C3            184   putchar:
03C3 3099FD     185       jnb TI, putchar
03C6 C299       186       clr TI
03C8 F599       187       mov SBUF, a
03CA 22         188       ret
03CB            189   
03CB            190   ; Send a constant-zero-terminated string using the serial port
03CB            191   SendString:
03CB E4         192       clr A
03CC 93         193       movc A, @A+DPTR
03CD 6006       194       jz SendStringDone
03CF 1203C3     195       lcall putchar
03D2 A3         196       inc DPTR
03D3 80F6       197       sjmp SendString
03D5            198   SendStringDone:
03D5 22         199       ret
03D6            200       
03D6            201   INIT_SPI:
03D6 D2A2       202            setb MY_MISO ; Make MISO an input pin
03D8 C2A3       203            clr MY_SCLK ; For mode (0,0) SCLK is zero
03DA 22         204            ret
03DB            205   
03DB            206   DO_SPI_G:
03DB C0E0       207            push acc
03DD 7900       208            mov R1, #0 ; Received byte stored in R1
03DF 7A08       209            mov R2, #8 ; Loop counter (8-bits)
03E1            210   DO_SPI_G_LOOP:
03E1 E8         211            mov a, R0 ; Byte to write is in R0
03E2 33         212            rlc a ; Carry flag has bit to write
03E3 F8         213            mov R0, a
03E4 92A1       214            mov MY_MOSI, c
03E6 D2A3       215            setb MY_SCLK ; Transmit
03E8 A2A2       216            mov c, MY_MISO ; Read received bit
03EA E9         217            mov a, R1 ; Save received bit in R1
03EB 33         218            rlc a
03EC F9         219            mov R1, a
03ED C2A3       220            clr MY_SCLK
03EF DAF0       221            djnz R2, DO_SPI_G_LOOP
03F1 D0E0       222            pop acc
03F3 22         223            ret
03F4            224    
03F4            225   Hello_World:
03F4 48656C6C   226       DB  'Hello, World!', '\r', '\n', 0
     6F2C2057
     6F726C64
     210D0A00
0404            227       
0404            228   Delay:
0404 79DE       229            mov R1, #222
0406 78A6       230       mov R0, #166
0408 D8FE       231       djnz R0, $   ; 3 cycles->3*45.21123ns*166=22.51519us
040A D9FA       232       djnz R1, $-4 ; 22.51519us*222=4.998ms
040C 32         233       reti
040D            234       
                235   Left_blank mac
                236   	mov a, %0
                237   	anl a, #0xf0
                238   	swap a
                239   	jz Left_blank_%M_a
                240   	ljmp %1
                241   Left_blank_%M_a:
                242   	Display_char(#' ')
                243   	mov a, %0
                244   	anl a, #0x0f
                245   	jz Left_blank_%M_b
                246   	ljmp %1
                247   Left_blank_%M_b:
                248   	Display_char(#' ')
                249   endmac
040D            250      
040D            251   ; Sends 10-digit BCD number in bcd to the LCD 
040D            252   Display_10_digit_BCD:
040D C0E0       253            push acc
040F 7407       253            mov a, #7
0411 14         253            dec a
0412 12032F     253            lcall ?Set_Cursor_2 ; Select column and row
0415 D0E0       253            pop acc
0417 C000       254            push ar0
0419 A842       254            mov r0, bcd+4
041B 120336     254            lcall ?Display_BCD
041E D000       254            pop ar0
0420 C000       255            push ar0
0422 A841       255            mov r0, bcd+3
0424 120336     255            lcall ?Display_BCD
0427 D000       255            pop ar0
0429 C000       256            push ar0
042B A840       256            mov r0, bcd+2
042D 120336     256            lcall ?Display_BCD
0430 D000       256            pop ar0
0432 C000       257            push ar0
0434 A83F       257            mov r0, bcd+1
0436 120336     257            lcall ?Display_BCD
0439 D000       257            pop ar0
043B C000       258            push ar0
043D A83E       258            mov r0, bcd+0
043F 120336     258            lcall ?Display_BCD
0442 D000       258            pop ar0
0444            259            ; Replace all the zeros to the left with blanks
0444 C0E0       260            push acc
0446 7407       260            mov a, #7
0448 14         260            dec a
0449 12032F     260            lcall ?Set_Cursor_2 ; Select column and row
044C D0E0       260            pop acc
044E E542       261            mov a, bcd+4
0450 54F0       261            anl a, #0xf0
0452 C4         261            swap a
0453 6003       261            jz Left_blank_16_a
0455 0204F2     261            ljmp skip_blank
0458            261   Left_blank_16_a:
0458 C0E0       261            push acc
045A 7420       261            mov a, #' '
045C 1202EE     261            lcall ?WriteData
045F D0E0       261            pop acc
0461 E542       261            mov a, bcd+4
0463 540F       261            anl a, #0x0f
0465 6003       261            jz Left_blank_16_b
0467 0204F2     261            ljmp skip_blank
046A            261   Left_blank_16_b:
046A C0E0       261            push acc
046C 7420       261            mov a, #' '
046E 1202EE     261            lcall ?WriteData
0471 D0E0       261            pop acc
0473 E541       262            mov a, bcd+3
0475 54F0       262            anl a, #0xf0
0477 C4         262            swap a
0478 6003       262            jz Left_blank_19_a
047A 0204F2     262            ljmp skip_blank
047D            262   Left_blank_19_a:
047D C0E0       262            push acc
047F 7420       262            mov a, #' '
0481 1202EE     262            lcall ?WriteData
0484 D0E0       262            pop acc
0486 E541       262            mov a, bcd+3
0488 540F       262            anl a, #0x0f
048A 6003       262            jz Left_blank_19_b
048C 0204F2     262            ljmp skip_blank
048F            262   Left_blank_19_b:
048F C0E0       262            push acc
0491 7420       262            mov a, #' '
0493 1202EE     262            lcall ?WriteData
0496 D0E0       262            pop acc
0498 E540       263            mov a, bcd+2
049A 54F0       263            anl a, #0xf0
049C C4         263            swap a
049D 6003       263            jz Left_blank_22_a
049F 0204F2     263            ljmp skip_blank
04A2            263   Left_blank_22_a:
04A2 C0E0       263            push acc
04A4 7420       263            mov a, #' '
04A6 1202EE     263            lcall ?WriteData
04A9 D0E0       263            pop acc
04AB E540       263            mov a, bcd+2
04AD 540F       263            anl a, #0x0f
04AF 6003       263            jz Left_blank_22_b
04B1 0204F2     263            ljmp skip_blank
04B4            263   Left_blank_22_b:
04B4 C0E0       263            push acc
04B6 7420       263            mov a, #' '
04B8 1202EE     263            lcall ?WriteData
04BB D0E0       263            pop acc
04BD E53F       264            mov a, bcd+1
04BF 54F0       264            anl a, #0xf0
04C1 C4         264            swap a
04C2 6003       264            jz Left_blank_25_a
04C4 0204F2     264            ljmp skip_blank
04C7            264   Left_blank_25_a:
04C7 C0E0       264            push acc
04C9 7420       264            mov a, #' '
04CB 1202EE     264            lcall ?WriteData
04CE D0E0       264            pop acc
04D0 E53F       264            mov a, bcd+1
04D2 540F       264            anl a, #0x0f
04D4 6003       264            jz Left_blank_25_b
04D6 0204F2     264            ljmp skip_blank
04D9            264   Left_blank_25_b:
04D9 C0E0       264            push acc
04DB 7420       264            mov a, #' '
04DD 1202EE     264            lcall ?WriteData
04E0 D0E0       264            pop acc
04E2 E53E       265            mov a, bcd+0
04E4 54F0       266            anl a, #0f0h
04E6 C4         267            swap a
04E7 7009       268            jnz skip_blank
04E9 C0E0       269            push acc
04EB 7420       269            mov a, #' '
04ED 1202EE     269            lcall ?WriteData
04F0 D0E0       269            pop acc
04F2            270   skip_blank:
04F2 22         271            ret
04F3            272            
04F3            273   Display_10_digit_BCD_2:
04F3 C0E0       274            push acc
04F5 7407       274            mov a, #7
04F7 14         274            dec a
04F8 120331     274            lcall ?Set_Cursor_1 ; Select column and row
04FB D0E0       274            pop acc
04FD C000       275            push ar0
04FF A842       275            mov r0, bcd+4
0501 120336     275            lcall ?Display_BCD
0504 D000       275            pop ar0
0506 C000       276            push ar0
0508 A841       276            mov r0, bcd+3
050A 120336     276            lcall ?Display_BCD
050D D000       276            pop ar0
050F C000       277            push ar0
0511 A840       277            mov r0, bcd+2
0513 120336     277            lcall ?Display_BCD
0516 D000       277            pop ar0
0518 C000       278            push ar0
051A A83F       278            mov r0, bcd+1
051C 120336     278            lcall ?Display_BCD
051F D000       278            pop ar0
0521 C000       279            push ar0
0523 A83E       279            mov r0, bcd+0
0525 120336     279            lcall ?Display_BCD
0528 D000       279            pop ar0
052A            280            ; Replace all the zeros to the left with blanks
052A C0E0       281            push acc
052C 7407       281            mov a, #7
052E 14         281            dec a
052F 120331     281            lcall ?Set_Cursor_1 ; Select column and row
0532 D0E0       281            pop acc
0534 E542       282            mov a, bcd+4
0536 54F0       282            anl a, #0xf0
0538 C4         282            swap a
0539 6003       282            jz Left_blank_36_a
053B 0205D8     282            ljmp skip_blank_2
053E            282   Left_blank_36_a:
053E C0E0       282            push acc
0540 7420       282            mov a, #' '
0542 1202EE     282            lcall ?WriteData
0545 D0E0       282            pop acc
0547 E542       282            mov a, bcd+4
0549 540F       282            anl a, #0x0f
054B 6003       282            jz Left_blank_36_b
054D 0205D8     282            ljmp skip_blank_2
0550            282   Left_blank_36_b:
0550 C0E0       282            push acc
0552 7420       282            mov a, #' '
0554 1202EE     282            lcall ?WriteData
0557 D0E0       282            pop acc
0559 E541       283            mov a, bcd+3
055B 54F0       283            anl a, #0xf0
055D C4         283            swap a
055E 6003       283            jz Left_blank_39_a
0560 0205D8     283            ljmp skip_blank_2
0563            283   Left_blank_39_a:
0563 C0E0       283            push acc
0565 7420       283            mov a, #' '
0567 1202EE     283            lcall ?WriteData
056A D0E0       283            pop acc
056C E541       283            mov a, bcd+3
056E 540F       283            anl a, #0x0f
0570 6003       283            jz Left_blank_39_b
0572 0205D8     283            ljmp skip_blank_2
0575            283   Left_blank_39_b:
0575 C0E0       283            push acc
0577 7420       283            mov a, #' '
0579 1202EE     283            lcall ?WriteData
057C D0E0       283            pop acc
057E E540       284            mov a, bcd+2
0580 54F0       284            anl a, #0xf0
0582 C4         284            swap a
0583 6003       284            jz Left_blank_42_a
0585 0205D8     284            ljmp skip_blank_2
0588            284   Left_blank_42_a:
0588 C0E0       284            push acc
058A 7420       284            mov a, #' '
058C 1202EE     284            lcall ?WriteData
058F D0E0       284            pop acc
0591 E540       284            mov a, bcd+2
0593 540F       284            anl a, #0x0f
0595 6003       284            jz Left_blank_42_b
0597 0205D8     284            ljmp skip_blank_2
059A            284   Left_blank_42_b:
059A C0E0       284            push acc
059C 7420       284            mov a, #' '
059E 1202EE     284            lcall ?WriteData
05A1 D0E0       284            pop acc
05A3 E53F       285            mov a, bcd+1
05A5 54F0       285            anl a, #0xf0
05A7 C4         285            swap a
05A8 6003       285            jz Left_blank_45_a
05AA 0205D8     285            ljmp skip_blank_2
05AD            285   Left_blank_45_a:
05AD C0E0       285            push acc
05AF 7420       285            mov a, #' '
05B1 1202EE     285            lcall ?WriteData
05B4 D0E0       285            pop acc
05B6 E53F       285            mov a, bcd+1
05B8 540F       285            anl a, #0x0f
05BA 6003       285            jz Left_blank_45_b
05BC 0205D8     285            ljmp skip_blank_2
05BF            285   Left_blank_45_b:
05BF C0E0       285            push acc
05C1 7420       285            mov a, #' '
05C3 1202EE     285            lcall ?WriteData
05C6 D0E0       285            pop acc
05C8 E53E       286            mov a, bcd+0
05CA 54F0       287            anl a, #0f0h
05CC C4         288            swap a
05CD 7009       289            jnz skip_blank_2
05CF C0E0       290            push acc
05D1 7420       290            mov a, #' '
05D3 1202EE     290            lcall ?WriteData
05D6 D0E0       290            pop acc
05D8            291   skip_blank_2:
05D8 22         292            ret
05D9            293   
05D9            294   ?Send_BCD:
05D9 C0E0       295            push acc
05DB            296            ; Write most significant digit
05DB E8         297            mov a, r0
05DC C4         298            swap a
05DD 540F       299            anl a, #0fh
05DF 4430       300            orl a, #30h
05E1 1203C3     301            lcall putchar
05E4            302            ; write least significant digit
05E4 E8         303            mov a, r0
05E5 540F       304            anl a, #0fh
05E7 4430       305            orl a, #30h
05E9 1203C3     306            lcall putchar
05EC D0E0       307            pop acc
05EE 22         308            ret
05EF            309   
05EF            310   ;____________________________________
05EF            311   ;*************************************
05EF            312   
05EF            313   ; This is the code that converts the amplified voltage from the the k-type thermocouple 
05EF            314   ; to temperature data for use. 
05EF            315   ; Current Parameters: 
05EF            316   ;                Op-amp gain: ~200
05EF            317   ;                Thermocouple conversion: 41 uV/celcius
05EF            318   ;                Reference Voltage: 4.096 
05EF            319   ; inputs
05EF            320   ;*************************************           
05EF            321   ;-------------------------------------           
05EF            322   
05EF            323   Voltage_to_temp_LM355: 
05EF 753AF1     324            mov y+0, #low (4081 % 0x10000) 
05F2 753B0F     324            mov y+1, #high(4081 % 0x10000) 
05F5 753C00     324            mov y+2, #low (4081 / 0x10000) 
05F8 753D00     324            mov y+3, #high(4081 / 0x10000) 
05FB 1201A8     325                        lcall mul32 ;multiplies x *= y
05FE            326                        
05FE            327                        ;A/1023 = B
05FE 753AFF     328            mov y+0, #low (1023 % 0x10000) 
0601 753B03     328            mov y+1, #high(1023 % 0x10000) 
0604 753C00     328            mov y+2, #low (1023 / 0x10000) 
0607 753D00     328            mov y+3, #high(1023 / 0x10000) 
060A 120235     329                        lcall div32 ;divides x /= y
060D            330                        
060D            331                        ;B - 2730 = C
060D 753AAA     332            mov y+0, #low (2730 % 0x10000) 
0610 753B0A     332            mov y+1, #high(2730 % 0x10000) 
0613 753C00     332            mov y+2, #low (2730 / 0x10000) 
0616 753D00     332            mov y+3, #high(2730 / 0x10000) ;
0619 120114     333                        lcall sub32
061C            334                        
061C            335                        ;B/10 = V_OUT
061C 753A0A     336            mov y+0, #low (10 % 0x10000) 
061F 753B00     336            mov y+1, #high(10 % 0x10000) 
0622 753C00     336            mov y+2, #low (10 / 0x10000) 
0625 753D00     336            mov y+3, #high(10 / 0x10000) ;
0628 120235     337                        lcall div32 ;divides x /= y
062B 22         338            ret
062C            339   
062C            340     Voltage_to_temp_thermocouple: 
062C            341   
062C 753AF1     342            mov y+0, #low (4081 % 0x10000) 
062F 753B0F     342            mov y+1, #high(4081 % 0x10000) 
0632 753C00     342            mov y+2, #low (4081 / 0x10000) 
0635 753D00     342            mov y+3, #high(4081 / 0x10000) 
0638 1201A8     343            lcall mul32 ;multiplies x *= y
063B            344            
063B 753AAB     345            mov y+0, #low (2475 % 0x10000) 
063E 753B09     345            mov y+1, #high(2475 % 0x10000) 
0641 753C00     345            mov y+2, #low (2475 / 0x10000) 
0644 753D00     345            mov y+3, #high(2475 / 0x10000)          ; 24.75 c/mV
0647 1201A8     346       lcall mul32          ; x*=y
064A            347       
064A            348       ;A/1023 = B
064A 753AFF     349            mov y+0, #low (1023 % 0x10000) 
064D 753B03     349            mov y+1, #high(1023 % 0x10000) 
0650 753C00     349            mov y+2, #low (1023 / 0x10000) 
0653 753D00     349            mov y+3, #high(1023 / 0x10000) 
0656 120235     350       lcall div32 ;divides x /= y
0659            351       
0659            352       ;keep in milli
0659 753AE8     353            mov y+0, #low (1000 % 0x10000) 
065C 753B03     353            mov y+1, #high(1000 % 0x10000) 
065F 753C00     353            mov y+2, #low (1000 / 0x10000) 
0662 753D00     353            mov y+3, #high(1000 / 0x10000) 
0665 1201A8     354       lcall mul32 ;divides x /= y
0668            355       
0668 753AC8     356            mov y+0, #low (200 % 0x10000) 
066B 753B00     356            mov y+1, #high(200 % 0x10000) 
066E 753C00     356            mov y+2, #low (200 / 0x10000) 
0671 753D00     356            mov y+3, #high(200 / 0x10000) 
0674 120235     357       lcall div32
0677            358       
0677 753A64     359            mov y+0, #low (100 % 0x10000) 
067A 753B00     359            mov y+1, #high(100 % 0x10000) 
067D 753C00     359            mov y+2, #low (100 / 0x10000) 
0680 753D00     359            mov y+3, #high(100 / 0x10000) 
0683 120235     360       lcall div32
0686            361     
0686 753A32     362            mov y+0, #low (Result % 0x10000) 
0689 753B00     362            mov y+1, #high(Result % 0x10000) 
068C 753C00     362            mov y+2, #low (Result / 0x10000) 
068F 753D00     362            mov y+3, #high(Result / 0x10000) 
0692 1200F3     363            lcall add32    
0695            364       
0695 22         365      ret
0696            366     
0696            367   
0696            368   
0696            369   
0696            370   MainProgram:
0696 75817F     371       mov SP, #7FH ; Set the stack pointer to the begining of idata
0699            372       
0699            373       ;lcall Timer0_Init
0699 120368     374       lcall Timer2_Init
069C            375       ; In case you decide to use the pins of P0, configure the port in bidirectional mode:
069C 75E600     376       mov P0M0, #0
069F 75E700     377       mov P0M1, #0
06A2 D2AF       378       setb EA   ; Enable Global interrupts
06A4            379       
06A4 1203AB     380       lcall InitSerialPort
06A7 9003F4     381       mov DPTR, #Hello_World
06AA 1203CB     382       lcall SendString
06AD            383       
06AD 1203D6     384       lcall INIT_SPI
06B0 1202F8     385       lcall LCD_4BIT
06B3            386       
06B3            387   forever:
06B3 00         388   nop
06B4            389   GET_TEMP_DATA: 
06B4 C2A0       390       clr CE_ADC         ; selects 
06B6 7801       391       mov R0, #00000001B ; Start bit: 1
06B8 1203DB     392       lcall DO_SPI_G
06BB            393       
06BB 7880       394       mov R0, #10000000B ; Read channel 0
06BD 1203DB     395       lcall DO_SPI_G
06C0 E9         396       mov a, R1
06C1 5403       397       anl a, #00000011B
06C3 F533       398       mov Result+1, a    ; Save high result
06C5            399       
06C5 7855       400       mov R0, #55H
06C7 1203DB     401       lcall DO_SPI_G
06CA 8932       402       mov Result, R1     ; Save low result
06CC            403       
06CC D2A0       404       setb CE_ADC        ; deselects
06CE            405       
06CE            406       ;V_OUT = ADC_voltage*4.096V/1023
06CE            407       ;ADC_voltage*4096 = A
06CE 853236     408       mov x+0, Result
06D1 853337     409       mov x+1, Result+1
06D4 753800     410       mov x+2, #0
06D7 753900     411       mov x+3, #0
06DA            412       
06DA 1205EF     413       lcall Voltage_to_temp_LM355
06DD            414            
06DD 12002E     415       lcall hex2bcd
06E0 12040D     416       lcall Display_10_digit_BCD
06E3            417       
06E3 C2A0       418       clr CE_ADC         ; selects 
06E5 7801       419       mov R0, #00000001B ; Start bit: 1
06E7 1203DB     420       lcall DO_SPI_G
06EA            421       
06EA 7890       422       mov R0, #10010000B ; Read channel 1
06EC 1203DB     423       lcall DO_SPI_G
06EF E9         424       mov a, R1
06F0 5403       425       anl a, #00000011B
06F2 F535       426       mov Result_Thermo+1, a    ; Save high result
06F4            427       
06F4 7855       428       mov R0, #55H
06F6 1203DB     429       lcall DO_SPI_G
06F9 8934       430       mov Result_Thermo, R1     ; Save low result
06FB D2A0       431       setb CE_ADC        ; deselects
06FD            432       
06FD            433       ;V_OUT = ADC_voltage*4.096V/1023
06FD            434       ;ADC_voltage*4096 = A
06FD 853436     435       mov x+0, Result_Thermo
0700 853537     436       mov x+1, Result_Thermo+1
0703 753800     437       mov x+2, #0
0706 753900     438       mov x+3, #0
0709            439       
0709 12062C     440       lcall Voltage_to_temp_thermocouple
070C            441       
070C 12002E     442            lcall hex2bcd
070F 1204F3     443       lcall Display_10_digit_BCD_2
0712            444       
0712 120404     445       lcall Delay
0715 0206B3     446       ljmp forever ; This is equivalent to 'forever: sjmp forever'
0718 22         447       ret
0719            448            
0719            449   
0719            450   
0719            451   EN
