                 -1   $MODLP51
0000              1   ;--------------------------------------------------------
0000              2   ; Special Function Registers
0000              3   ;--------------------------------------------------------
0000              4   ACC            DATA 0xe0
0000              5   B              DATA 0xf0
0000              6   PSW            DATA 0xd0
0000              7   SP             DATA 0x81
0000              8   SPX            DATA 0xef
0000              9   DPL            DATA 0x82
0000             10   DPH            DATA 0x83
0000             11   DPLB           DATA 0xd4
0000             12   DPHB           DATA 0xd5
0000             13   PAGE           DATA 0xf6
0000             14   AX             DATA 0xe1
0000             15   BX             DATA 0xf7
0000             16   DSPR           DATA 0xe2
0000             17   FIRD           DATA 0xe3
0000             18   MACL           DATA 0xe4
0000             19   MACH           DATA 0xe5
0000             20   PCON           DATA 0x87
0000             21   AUXR           DATA 0x8e
0000             22   AUXR1          DATA 0xa2
0000             23   DPCF           DATA 0xa1
0000             24   CKRL           DATA 0x97
0000             25   CKCKON0        DATA 0x8f
0000             26   CKCKON1        DATA 0xaf
0000             27   CKSEL          DATA 0x85
0000             28   CLKREG         DATA 0xae
0000             29   OSCCON         DATA 0x85
0000             30   IE             DATA 0xa8
0000             31   IEN0           DATA 0xa8
0000             32   IEN1           DATA 0xb1
0000             33   IPH0           DATA 0xb7
0000             34   IP             DATA 0xb8
0000             35   IPL0           DATA 0xb8
0000             36   IPH1           DATA 0xb3
0000             37   IPL1           DATA 0xb2
0000             38   P0             DATA 0x80
0000             39   P1             DATA 0x90
0000             40   P2             DATA 0xa0
0000             41   P3             DATA 0xb0
0000             42   P4             DATA 0xc0
0000             43   P0M0           DATA 0xe6
0000             44   P0M1           DATA 0xe7
0000             45   P1M0           DATA 0xd6
0000             46   P1M1           DATA 0xd7
0000             47   P2M0           DATA 0xce
0000             48   P2M1           DATA 0xcf
0000             49   P3M0           DATA 0xc6
0000             50   P3M1           DATA 0xc7
0000             51   P4M0           DATA 0xbe
0000             52   P4M1           DATA 0xbf
0000             53   SCON           DATA 0x98
0000             54   SBUF           DATA 0x99
0000             55   SADEN          DATA 0xb9
0000             56   SADDR          DATA 0xa9
0000             57   BDRCON         DATA 0x9b
0000             58   BRL            DATA 0x9a
0000             59   TCON           DATA 0x88
0000             60   TMOD           DATA 0x89
0000             61   TCONB          DATA 0x91
0000             62   TL0            DATA 0x8a
0000             63   TH0            DATA 0x8c
0000             64   TL1            DATA 0x8b
0000             65   TH1            DATA 0x8d
0000             66   RL0            DATA 0xf2
0000             67   RL1            DATA 0xf3
0000             68   RH0            DATA 0xf4
0000             69   RH1            DATA 0xf5
0000             70   WDTRST         DATA 0xa6
0000             71   WDTPRG         DATA 0xa7
0000             72   T2CON          DATA 0xc8
0000             73   T2MOD          DATA 0xc9
0000             74   RCAP2H         DATA 0xcb
0000             75   RCAP2L         DATA 0xca
0000             76   TH2            DATA 0xcd
0000             77   TL2            DATA 0xcc
0000             78   SPCON          DATA 0xc3
0000             79   SPSTA          DATA 0xc4
0000             80   SPDAT          DATA 0xc5
0000             81   SSCON          DATA 0x93
0000             82   SSCS           DATA 0x94
0000             83   SSDAT          DATA 0x95
0000             84   SSADR          DATA 0x96
0000             85   KBLS           DATA 0x9c
0000             86   KBE            DATA 0x9d
0000             87   KBF            DATA 0x9e
0000             88   KBMOD          DATA 0x9f
0000             89   BMSEL          DATA 0x92
0000             90   FCON           DATA 0xd2
0000             91   EECON          DATA 0xd2
0000             92   ACSRA          DATA 0xa3
0000             93   ACSRB          DATA 0xab
0000             94   AREF           DATA 0xbd
0000             95   DADC           DATA 0xa4
0000             96   DADI           DATA 0xa5
0000             97   DADL           DATA 0xac
0000             98   DADH           DATA 0xad
0000             99   CCON           DATA 0xd8
0000            100   CMOD           DATA 0xd9
0000            101   CL             DATA 0xe9
0000            102   CH             DATA 0xf9
0000            103   CCAPM0         DATA 0xda
0000            104   CCAPM1         DATA 0xdb
0000            105   CCAPM2         DATA 0xdc
0000            106   CCAPM3         DATA 0xdd
0000            107   CCAPM4         DATA 0xde
0000            108   CCAP0H         DATA 0xfa
0000            109   CCAP1H         DATA 0xfb
0000            110   CCAP2H         DATA 0xfc
0000            111   CCAP3H         DATA 0xfd
0000            112   CCAP4H         DATA 0xfe
0000            113   CCAP0L         DATA 0xea
0000            114   CCAP1L         DATA 0xeb
0000            115   CCAP2L         DATA 0xec
0000            116   CCAP3L         DATA 0xed
0000            117   CCAP4L         DATA 0xee
0000            118   ;--------------------------------------------------------
0000            119   ; special function bits
0000            120   ;--------------------------------------------------------
0000            121   P              BIT 0xd0
0000            122   F1             BIT 0xd1
0000            123   OV             BIT 0xd2
0000            124   RS0            BIT 0xd3
0000            125   RS1            BIT 0xd4
0000            126   F0             BIT 0xd5
0000            127   AC             BIT 0xd6
0000            128   CY             BIT 0xd7
0000            129   EX0            BIT 0xa8
0000            130   ET0            BIT 0xa9
0000            131   EX1            BIT 0xaa
0000            132   ET1            BIT 0xab
0000            133   ES             BIT 0xac
0000            134   ET2            BIT 0xad
0000            135   EC             BIT 0xae
0000            136   EA             BIT 0xaf
0000            137   PX0            BIT 0xb8
0000            138   PT0            BIT 0xb9
0000            139   PX1            BIT 0xba
0000            140   PT1            BIT 0xbb
0000            141   PS             BIT 0xbc
0000            142   PT2            BIT 0xbd
0000            143   IP0D           BIT 0xbf
0000            144   PPCL           BIT 0xbe
0000            145   PT2L           BIT 0xbd
0000            146   PLS            BIT 0xbc
0000            147   PT1L           BIT 0xbb
0000            148   PX1L           BIT 0xba
0000            149   PT0L           BIT 0xb9
0000            150   PX0L           BIT 0xb8
0000            151   RXD            BIT 0xb0
0000            152   TXD            BIT 0xb1
0000            153   INT0           BIT 0xb2
0000            154   INT1           BIT 0xb3
0000            155   T0             BIT 0xb4
0000            156   T1             BIT 0xb5
0000            157   WR             BIT 0xb6
0000            158   RD             BIT 0xb7
0000            159   RI             BIT 0x98
0000            160   TI             BIT 0x99
0000            161   RB8            BIT 0x9a
0000            162   TB8            BIT 0x9b
0000            163   REN            BIT 0x9c
0000            164   SM2            BIT 0x9d
0000            165   SM1            BIT 0x9e
0000            166   SM0            BIT 0x9f
0000            167   IT0            BIT 0x88
0000            168   IE0            BIT 0x89
0000            169   IT1            BIT 0x8a
0000            170   IE1            BIT 0x8b
0000            171   TR0            BIT 0x8c
0000            172   TF0            BIT 0x8d
0000            173   TR1            BIT 0x8e
0000            174   TF1            BIT 0x8f
0000            175   CP_RL2         BIT 0xc8
0000            176   C_T2           BIT 0xc9
0000            177   TR2            BIT 0xca
0000            178   EXEN2          BIT 0xcb
0000            179   TCLK           BIT 0xcc
0000            180   RCLK           BIT 0xcd
0000            181   EXF2           BIT 0xce
0000            182   TF2            BIT 0xcf
0000            183   CF             BIT 0xdf
0000            184   CR             BIT 0xde
0000            185   CCF4           BIT 0xdc
0000            186   CCF3           BIT 0xdb
0000            187   CCF2           BIT 0xda
0000            188   CCF1           BIT 0xd9
0000            189   CCF0           BIT 0xd8
0000              2   
0000              3   ; There is a couple of typos in MODLP51 in the definition of the timer 0/1 reload
0000              4   ; special function registers (SFRs), so:
0000              5   
0000              6   TIMER0_RELOAD_L DATA 0xf2
0000              7   TIMER1_RELOAD_L DATA 0xf3
0000              8   TIMER0_RELOAD_H DATA 0xf4
0000              9   TIMER1_RELOAD_H DATA 0xf5
0000             10   
0000             11   CLK              EQU 22118400 ; Microcontroller system crystal frequency in Hz
0000             12   TIMER0_RATE      EQU 4096     ; 2048Hz squarewave (peak amplitude of CEM-1203 speaker)
0000             13   TIMER0_RELOAD    EQU ((65536-(CLK/TIMER0_RATE)))
0000             14   TIMER2_RATE      EQU 1000     ; 1000Hz, for a timer tick of 1ms
0000             15   TIMER2_RELOAD    EQU ((65536-(CLK/TIMER2_RATE)))
0000             16   MAX_TEMP              EQU 250
0000             17   TIMEOUT_TIME     EQU 60
0000             18   BAUD             EQU 115200
0000             19   BRG_VAL          EQU (0x100-(CLK/(16*BAUD)))
0000             20   MILLISECOND_WAIT EQU 200                 ; how many milliseconds between temp samples, needs to be a number evenly divisible into 1000
0000             21   Seconds_coeff     equ (1000/MILLISECOND_WAIT)
0000             22   
0000             23   DUTY_0           EQU 0
0000             24   DUTY_20          EQU 51   ;256 * 0.2
0000             25   DUTY_50          EQU 128  ;256 * 0.5
0000             26   DUTY_80          EQU 204  ;256 * 0.8
0000             27   DUTY_100         EQU 255
0000             28   
0000             29   org 0x0000
0000 021C46      30      ljmp MainProgram
0003             31   
0003             32   ; External interrupt 0 vector (not used in this code)
0003             33   org 0x0003
0003 32          34            reti
0004             35   
0004             36   ; Timer/Counter 0 overflow interrupt vector
000B             37   org 0x000B
000B 021BD4      38            ljmp Timer0_ISR
000E             39   
000E             40   ; External interrupt 1 vector (not used in this code)
0013             41   org 0x0013
0013 32          42            reti
0014             43   
0014             44   ; Timer/Counter 1 overflow interrupt vector (not used in this code)
001B             45   org 0x001B
001B 32          46            reti
001C             47   
001C             48   ; Serial port receive/transmit interrupt vector (not used in this code)
0023             49   org 0x0023 
0023 32          50            reti
0024             51            
0024             52   ; Timer/Counter 2 overflow interrupt vector
002B             53   org 0x002B
002B 021C11      54            ljmp Timer2_ISR
002E             55   
002E             56   ;Edge triggered keyboard interrupt vector
003B             57   org 0x003B
003B 32          58            reti
003C             59   
003C             60   ; These ’EQU’ must match the wiring between the microcontroller and ADC
003C             61   SOUND_OUT     EQU P3.7
003C             62   CE_ADC        EQU P2.0
003C             63   MY_MOSI       EQU P2.1
003C             64   MY_MISO       EQU P2.2
003C             65   MY_SCLK       EQU P2.3
003C             66   
003C             67   UP_BUTTON          EQU P2.6 
003C             68   DOWN_BUTTON   EQU P2.5
003C             69   SELECT_BUTTON equ P2.4
003C             70   BACK_BUTTON   EQU #11110000B
003C             71   MASTER_START  EQU #10100000B 
003C             72   MASTER_STOP   EQU #10110000B
003C             73   
003C             74   ; For the 7-segment display
003C             75   SEGA equ P0.3
003C             76   SEGB equ P0.5
003C             77   SEGC equ P0.7
003C             78   SEGD equ P4.4
003C             79   SEGE equ P4.5
003C             80   SEGF equ P0.4
003C             81   SEGG equ P0.6
003C             82   SEGP equ P2.7
003C             83   CA1  equ P0.1
003C             84   CA2  equ P0.0
003C             85   CA3  equ P0.2
003C             86   
003C             87   ; For the LCD
003C             88   LCD_RS equ P1.1
003C             89   LCD_RW equ P1.2
003C             90   LCD_E  equ P1.3
003C             91   LCD_D4 equ P3.2
003C             92   LCD_D5 equ P3.3
003C             93   LCD_D6 equ P3.4
003C             94   LCD_D7 equ P3.6
003C             95   
003C             96   ; pins to be used on the MPC 3008
003C             97   adc_zero                 equ #10000000B               ; LM355 temp sensor 
003C             98   adc_one                  equ #10010000B               ; thermocouple
003C             99   adc_two                  equ #10100000B               ;  start
003C            100   adc_three                equ #10110000B               ;  stop
003C            101   adc_four                 equ #11000000B               ;  
003C            102   adc_five                 equ #11010000B               ;  
003C            103   adc_six                  equ #11100000B               ; 
003C            104   adc_seven                equ #11110000B                           ; back
003C            105   
0030            106   DSEG at 0x30
0030            107   Count1ms:       ds 2 ; Used to determine when half second has passed
0032            108   Result:         ds 2 ; Temp from lm355
0034            109   Result_Thermo:  ds 2 ; Temp from Thermocoupler
0036            110   ADC_Result:     ds 2 ; Temp from ADC channel 2
0038            111   
0038            112   BCD_temp:       ds 2 ; Used to diplay temp on the 7-segment display
003A            113   seconds:        ds 1
003B            114   polling_time:    ds 1
003C            115   x:              ds 4 ; Used in math32
0040            116   y:              ds 4 ; Used in math32
0044            117   bcd:            ds 5
0049            118   soaktime:       ds 2
004B            119   soaktemp:       ds 2
004D            120   reflowtime:     ds 2
004F            121   reflowtemp:     ds 2
0051            122   soaktemp3digit: ds 2
0053            123   reflow_state:   ds 1
0054            124   pwm:            ds 1
0055            125   temp:           ds 1
0056            126   sec:            ds 1 ; seconds variable for reflow FSM (to be incremented every second)
0057            127   cooled_temp:    ds 1
0058            128   ; 7-segment vars
0058            129   
0058            130   disp1:          ds 1 ; Least significant digit
0059            131   disp2:          ds 1
005A            132   disp3:          ds 1 ; Most significant digit
005B            133   seg_state:      ds 1 ; state of 7_seg fsm
005C            134   display_scratch: ds 1
005D            135   seconds_state4: ds 1
005E            136   ;sec_check: ds 1
005E            137   ;Beep Machine vars
005E            138   beep_state:     ds 1
005F            139   one_beep_count: ds 1
0060            140   
0060            141   
0000            142   BSEG
0000            143   mf: dbit 1
0001            144   one_second_flag: dbit 1 
0002            145   polling_flag: dbit 1
0003            146   shortbeepflag: dbit 1
0004            147   longbeepflag: dbit 1
0005            148   sixbeepflag: dbit 1
0006            149   state4_flag: dbit 1
0007            150   
0007            151   
003C            152   CSEG
003C            153                    ;                        1234567890123456
003C 20202020   154   Ramp_to_Soak:    db       '         Preheat', 0
     20202020
     20507265
     68656174
     00
004D 20202020   155   Soak:                    db   '         Soak   ', 0
     20202020
     20536F61
     6B202020
     00
005E 20202020   156   Ramp_to_Peak:    db       '         Ramp2pk', 0
     20202020
     2052616D
     7032706B
     00
006F 20202020   157   Reflow:                  db       '         Reflow ', 0
     20202020
     20526566
     6C6F7720
     00
0080 20202020   158   Cooling:                 db       '         Cooling', 0
     20202020
     20436F6F
     6C696E67
     00
0091 7300       159   secondsss:               db   's'                , 0
0093            160   ;                     1234567890123456    <- This helps determine the location of the counter
0093 57656C63   161   Welcome:                   db 'Welcome!        ', 0
     6F6D6521
     20202020
     20202020
     00
00A4 53656C65   162   Choose_option:     db 'Select option   ', 0
     6374206F
     7074696F
     6E202020
     00
00B5 50726573   163   Preset_menu_msg:  db 'Preset Profile  ', 0
     65742050
     726F6669
     6C652020
     00
00C6 43757374   164   Custom_menu_msg:  db 'Custom Profile  ', 0
     6F6D2050
     726F6669
     6C652020
     00
00D7 536F616B   165   Soak_temp:                 db 'Soak Temp       ', 0
     2054656D
     70202020
     20202020
     00
00E8 536F616B   166   Soak_time:                 db 'Soak Time       ', 0
     2054696D
     65202020
     20202020
     00
00F9 5265666C   167   Reflow_time:       db 'Reflow Time     ', 0
     6F772054
     696D6520
     20202020
     00
010A 5265666C   168   Reflow_temp:       db 'Reflow Temp     ', 0
     6F772054
     656D7020
     20202020
     00
011B 53414333   169   Pb_free_solder:    db 'SAC305 solder   ', 0
     30352073
     6F6C6465
     72202020
     00
012C 50622D73   170   Pb_solder:                 db 'Pb-solder paste ', 0
     6F6C6465
     72207061
     73746520
     00
013D 53686868   171   Pizza_msg0:        db 'Shhh! No pizza  ', 0
     21204E6F
     2070697A
     7A612020
     00
014E 616C6C6F   172   Pizza_msg1:        db 'allowed in here.', 0
     77656420
     696E2068
     6572652E
     00
015F 70726F66   173   Profile_loaded:   db 'profile loaded  ', 0
     696C6520
     6C6F6164
     65642020
     00
0170 53797374   174   Is_ready:                  db 'System Ready    ', 0
     656D2052
     65616479
     20202020
     00
0181 50726573   175   Press_start:       db 'Press Start     ', 0
     73205374
     61727420
     20202020
     00
0192 78782020   176   Set_Value:                 db 'xx              ', 0
     20202020
     20202020
     20202020
     00
01A3 20202020   177   Clear_Row:                 db '                ', 0
     20202020
     20202020
     20202020
     00
01B4 41542050   178   PRESETMENUMSG:     db 'AT PRESET MENU  ', 0
     52455345
     54204D45
     4E552020
     00
01C5 41542043   179   CUSTOMMENUMSG:     db 'AT CUSTOM MENU  ', 0
     5553544F
     4D204D45
     4E552020
     00
01D6 41726520   180   Are_you_sure:      db 'Are you sure?   ', 0
     796F7520
     73757265
     3F202020
     00
01E7 4572726F   181   Error_msg1:        db 'Error, profiles ', 0
     722C2070
     726F6669
     6C657320
     00
01F8 6E6F7420   182   Error_msg2:       db 'not loaded      ', 0
     6C6F6164
     65642020
     20202020
     00
0209 50726F63   183   Abort_string:      db 'Process aborted ', 0
     65737320
     61626F72
     74656420
     00
021A 57616974   184   Waiting_to_cool:  db 'Wait to cool    ', 0
     20746F20
     636F6F6C
     20202020
     00
022B 49535220   185   ISR_is_running:   db 'ISR is running  ', 0
     69732072
     756E6E69
     6E672020
     00
023C 5265666C   186   abort_msg:                 db 'Reflow Aborted! ', 0
     6F772041
     626F7274
     65642120
     00
024D            187   
024D 53746174   188   State_0: db 'State 0', 0
     65203000
0255 53746174   189   State_1: db 'State 1', 0
     65203100
025D            190   
025D C0F9A4B0   191   HEX_7SEG: DB 0xC0, 0xF9, 0xA4, 0xB0, 0x99, 0x92, 0x82, 0xF8, 0x80, 0x90
     999282F8
     8090
0267            192   
0267            193   
                195   	$LIST
0315            197   
                546   $LIST
                199   $LIST
0585            201   
                203   $LIST
13A8            205   
                207   $LIST
1741            209   
                211   $LIST
1B13            213   
                215   $LIST
1B95            217   
                219   $LIST
1BBD            221   ;----------------------------------------MACRO LOCATION----------------------------------------------
1BBD            222   
1BBD            223   
1BBD            224   
1BBD            225   
1BBD            226   ;---------------------------------;
1BBD            227   ; Routine to initialize the ISR   ;
1BBD            228   ; for timer 0                     ;
1BBD            229   ;---------------------------------;
1BBD            230   Timer0_Init:
1BBD E589       231            mov a, TMOD
1BBF 54F0       232            anl a, #0xf0 ; Clear the bits for timer 0
1BC1 4401       233            orl a, #0x01 ; Configure timer 0 as 16-timer
1BC3 F589       234            mov TMOD, a
1BC5 758CEA     235            mov TH0, #high(TIMER0_RELOAD)
1BC8 758AE8     236            mov TL0, #low(TIMER0_RELOAD)
1BCB            237            ; Set autoreload value
1BCB 75F4EA     238            mov TIMER0_RELOAD_H, #high(TIMER0_RELOAD)
1BCE 75F2E8     239            mov TIMER0_RELOAD_L, #low(TIMER0_RELOAD)
1BD1            240            ; Enable the timer and interrupts
1BD1 D2A9       241       setb ET0  ; Enable timer 0 interrupt
1BD3            242            ;setb TR0  ; Start timer 0
1BD3 22         243            ret
1BD4            244   
1BD4            245   ;---------------------------------;
1BD4            246   ; ISR for timer 0.  Set to execute;
1BD4            247   ; every 1/4096Hz to generate a    ;
1BD4            248   ; 2048 Hz square wave at pin P3.7 ;
1BD4            249   ;---------------------------------;
1BD4            250   Timer0_ISR:
1BD4            251            ;clr TF0  ; According to the data sheet this is done for us already.
1BD4            252            ;jb sho
1BD4            253            
1BD4            254            
1BD4            255            
1BD4            256            ;sjmp no_beep
1BD4            257   ;beep_on:
1BD4 B2B7       258            cpl SOUND_OUT ; Connect speaker to P3.7!
1BD6            259   ;no_beep:
1BD6 32         260            reti
1BD7            261            
1BD7            262   ;---------------------------------;
1BD7            263   ; Routine to initialize the ISR   ;
1BD7            264   ; for timer 1 in PWM mode         ;
1BD7            265   ;---------------------------------;
1BD7            266   
1BD7            267   Timer1_Init:
1BD7 E589       268            mov a, TMOD
1BD9 540F       269            anl a, #00001111B       ;Clears timer 1 settings but keeps timer 0 settings
1BDB 4410       270            orl a, #00010000B       ;Gate = 0, TC1 = 0, mode = 01 (mode 1)
1BDD F589       271            mov TMOD, a
1BDF            272            
1BDF E591       273            mov a, TCONB            ;load TCONB for PWM settings
1BE1 5400       274            anl a, #00000000B       ;clear TCONB
1BE3 4480       275            orl a, #10000000B       ;Set PWM1 = 1
1BE5 F591       276            mov TCONB, a
1BE7            277            
1BE7 758D00     278            mov TH1, #0             ;Current count value
1BEA 758B00     279            mov TL1, #0             ;Linear Prescaling
1BED            280            
1BED 75F500     281            mov TIMER1_RELOAD_H, #DUTY_0 ;Duty cycle percentage. Replace this value to change the duty cycle
1BF0 75F300     282            mov TIMER1_RELOAD_L, #0      ;Frequency scaling/adjust f_out = f_sys/(256 * (256 - TL))
1BF3            283            
1BF3 D28E       284            setb TR1
1BF5 32         285            reti
1BF6            286   
1BF6            287   ;---------------------------------;
1BF6            288   ; Routine to initialize the ISR   ;
1BF6            289   ; for timer 2                     ;
1BF6            290   ;---------------------------------;
1BF6            291   Timer2_Init:
1BF6 75C800     292            mov T2CON, #0 ; Stop timer/counter.  Autoreload mode.
1BF9 75CDA9     293            mov TH2, #high(TIMER2_RELOAD)
1BFC 75CC9A     294            mov TL2, #low(TIMER2_RELOAD)
1BFF            295            ; Set the reload value
1BFF 75CBA9     296            mov RCAP2H, #high(TIMER2_RELOAD)
1C02 75CA9A     297            mov RCAP2L, #low(TIMER2_RELOAD)
1C05            298            ; Init One millisecond interrupt counter.  It is a 16-bit variable made with two 8-bit parts
1C05 E4         299            clr a
1C06 F530       300            mov Count1ms+0, a
1C08 F531       301            mov Count1ms+1, a
1C0A F53B       302            mov polling_time, a     ; a variable used to increment one second as well as 200 ms
1C0C            303            ; Enable the timer and interrupts
1C0C D2AD       304       setb ET2  ; Enable timer 2 interrupt
1C0E D2CA       305       setb TR2  ; Enable timer 2
1C10 22         306            ret
1C11            307   
1C11            308   ;---------------------------------;
1C11            309   ; ISR for timer 2                 ;
1C11            310   ;---------------------------------;
1C11            311   Timer2_ISR:
1C11 C2CF       312            clr TF2  ; Timer 2 doesn't clear TF2 automatically. Do it in ISR
1C13            313   
1C13            314            ; The two registers used in the ISR must be saved in the stack
1C13 C0E0       315            push acc
1C15 C0D0       316            push psw
1C17 121B34     317            lcall seg_state_machine
1C1A            318            ; Increment the 16-bit one mili second counter
1C1A            319                            ;       inc Count1ms+0    ; Increment the low 8-bits first
1C1A            320                                    ;mov a, Count1ms+0
1C1A            321                            ;       cjne a, #10h, Timer2_ISR_done
1C1A            322                            ;       mov Count1ms+0, #0h
1C1A 0530       323            inc Count1ms+0    ; Increment the low 8-bits first
1C1C E530       324            mov a, Count1ms+0 ; If the low 8-bits overflow, then increment high 8-bits
1C1E 7002       325            jnz Inc_Done
1C20 0531       326            inc Count1ms+1
1C22            327            
1C22            328            ;Send_BCD(bcd)
1C22            329            Inc_Done:
1C22            330            ; Check if a second has passed
1C22            331   
1C22 E530       332            mov a, Count1ms+0
1C24 B4C81A     333            cjne a, #low(MILLISECOND_WAIT), Timer2_ISR_done ; Warning: this instruction changes the carry flag!
1C27 E531       334            mov a, Count1ms+1
1C29 B40015     335            cjne a, #high(MILLISECOND_WAIT), Timer2_ISR_done
1C2C            336            
1C2C            337            ; 200 milliseconds have passed.  Set a flag so the main program knows
1C2C            338   
1C2C D202       339            setb polling_flag
1C2E            340            
1C2E            341            ; Reset to zero the milli-seconds counter, it is a 16-bit variable
1C2E E4         342            clr a
1C2F F530       343            mov Count1ms+0, a
1C31 F531       344            mov Count1ms+1, a
1C33            345            
1C33            346            ;Checks if 1 second has passed (by checking if Seconds_coeff*Millisecond_wait interrupts have occured)
1C33 053B       347            inc polling_time
1C35 E53B       348            mov a, polling_time
1C37 B40507     349            cjne a, #Seconds_coeff, Timer2_ISR_done 
1C3A 753B00     350            mov polling_time, #0x00
1C3D D201       351            setb one_second_flag
1C3F            352            ; Increment the BCD seconds counter
1C3F 053A       353            inc seconds
1C41            354            ;add a, #0x01
1C41            355            ;da a ; Decimal adjust instruction.  Check datasheet for more details!
1C41            356            ;mov seconds, a
1C41            357            ;jnb state4_flag, Timer2_ISR_done
1C41            358            ;mov a, seconds_state4
1C41            359            ;add a, #0x01
1C41            360            ;da a ; Decimal adjust instruction.  Check datasheet for more details!
1C41            361   ;mov seconds_state4, a
1C41            362            
1C41            363   Timer2_ISR_done:
1C41 D0D0       364            pop psw
1C43 D0E0       365            pop acc
1C45 32         366            reti
1C46            367   
1C46            368   MainProgram:
1C46 75817F     369       mov SP, #7FH ; Set the stack pointer to the begining of idata
1C49            370   
1C49 121B6B     371            lcall seg_state_init
1C4C 121BBD     372       lcall Timer0_Init
1C4F 121BD7     373            lcall Timer1_Init
1C52 121BF6     374       lcall Timer2_Init
1C55 121B95     375            lcall beep_machine_init
1C58 C203       376            clr shortbeepflag
1C5A C204       377            clr longbeepflag
1C5C C205       378            clr sixbeepflag
1C5E 753A00     379            mov seconds, #0x00
1C61 755D00     380            mov seconds_state4, #0x00
1C64 755300     381            mov reflow_state, #0x00
1C67 75573C     382            mov cooled_temp, #60
1C6A            383       ; In case you decide to use the pins of P0, configure the port in bidirectional mode:
1C6A 75E600     384       mov P0M0, #0
1C6D 75E700     385       mov P0M1, #0
1C70            386            
1C70 758E11     387            mov AUXR, #00010001B ; Max memory.  P4.4 is a general purpose IO pin
1C73            388   
1C73 D2AF       389       setb EA   ; Enable Global interrupts
1C75            390       
1C75 1213BE     391            lcall InitSerialPort
1C78 1213E9     392            lcall INIT_SPI
1C7B 1202C1     393       lcall LCD_4BIT
1C7E            394            
1C7E            395   forever:
1C7E 12172C     396            lcall GET_TEMP_DATA      ;This is the lab3 derivative loop that grabs the data from the thermocouple, 
1C81 121B9E     397            lcall beep_state_machine
1C84 021741     398            ljmp reflow_state_machine       ; go do some stuff in the state_machine
1C87 80F5       399       sjmp forever ; This is equivalent to 'forever: sjmp forever'
1C89            400   
1C89            401       
1C89            402   EN
