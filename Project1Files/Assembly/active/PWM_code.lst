0000              1   
                 -1   $MODLP51
0000              1   ;--------------------------------------------------------
0000              2   ; Special Function Registers
0000              3   ;--------------------------------------------------------
0000              4   ACC            DATA 0xe0
0000              5   B              DATA 0xf0
0000              6   PSW            DATA 0xd0
0000              7   SP             DATA 0x81
0000              8   SPX            DATA 0xef
0000              9   DPL            DATA 0x82
0000             10   DPH            DATA 0x83
0000             11   DPLB           DATA 0xd4
0000             12   DPHB           DATA 0xd5
0000             13   PAGE           DATA 0xf6
0000             14   AX             DATA 0xe1
0000             15   BX             DATA 0xf7
0000             16   DSPR           DATA 0xe2
0000             17   FIRD           DATA 0xe3
0000             18   MACL           DATA 0xe4
0000             19   MACH           DATA 0xe5
0000             20   PCON           DATA 0x87
0000             21   AUXR           DATA 0x8e
0000             22   AUXR1          DATA 0xa2
0000             23   DPCF           DATA 0xa1
0000             24   CKRL           DATA 0x97
0000             25   CKCKON0        DATA 0x8f
0000             26   CKCKON1        DATA 0xaf
0000             27   CKSEL          DATA 0x85
0000             28   CLKREG         DATA 0xae
0000             29   OSCCON         DATA 0x85
0000             30   IE             DATA 0xa8
0000             31   IEN0           DATA 0xa8
0000             32   IEN1           DATA 0xb1
0000             33   IPH0           DATA 0xb7
0000             34   IP             DATA 0xb8
0000             35   IPL0           DATA 0xb8
0000             36   IPH1           DATA 0xb3
0000             37   IPL1           DATA 0xb2
0000             38   P0             DATA 0x80
0000             39   P1             DATA 0x90
0000             40   P2             DATA 0xa0
0000             41   P3             DATA 0xb0
0000             42   P4             DATA 0xc0
0000             43   P0M0           DATA 0xe6
0000             44   P0M1           DATA 0xe7
0000             45   P1M0           DATA 0xd6
0000             46   P1M1           DATA 0xd7
0000             47   P2M0           DATA 0xce
0000             48   P2M1           DATA 0xcf
0000             49   P3M0           DATA 0xc6
0000             50   P3M1           DATA 0xc7
0000             51   P4M0           DATA 0xbe
0000             52   P4M1           DATA 0xbf
0000             53   SCON           DATA 0x98
0000             54   SBUF           DATA 0x99
0000             55   SADEN          DATA 0xb9
0000             56   SADDR          DATA 0xa9
0000             57   BDRCON         DATA 0x9b
0000             58   BRL            DATA 0x9a
0000             59   TCON           DATA 0x88
0000             60   TMOD           DATA 0x89
0000             61   TCONB          DATA 0x91
0000             62   TL0            DATA 0x8a
0000             63   TH0            DATA 0x8c
0000             64   TL1            DATA 0x8b
0000             65   TH1            DATA 0x8d
0000             66   RL0            DATA 0xf2
0000             67   RL1            DATA 0xf3
0000             68   RH0            DATA 0xf4
0000             69   RH1            DATA 0xf5
0000             70   WDTRST         DATA 0xa6
0000             71   WDTPRG         DATA 0xa7
0000             72   T2CON          DATA 0xc8
0000             73   T2MOD          DATA 0xc9
0000             74   RCAP2H         DATA 0xcb
0000             75   RCAP2L         DATA 0xca
0000             76   TH2            DATA 0xcd
0000             77   TL2            DATA 0xcc
0000             78   SPCON          DATA 0xc3
0000             79   SPSTA          DATA 0xc4
0000             80   SPDAT          DATA 0xc5
0000             81   SSCON          DATA 0x93
0000             82   SSCS           DATA 0x94
0000             83   SSDAT          DATA 0x95
0000             84   SSADR          DATA 0x96
0000             85   KBLS           DATA 0x9c
0000             86   KBE            DATA 0x9d
0000             87   KBF            DATA 0x9e
0000             88   KBMOD          DATA 0x9f
0000             89   BMSEL          DATA 0x92
0000             90   FCON           DATA 0xd2
0000             91   EECON          DATA 0xd2
0000             92   ACSRA          DATA 0xa3
0000             93   ACSRB          DATA 0xab
0000             94   AREF           DATA 0xbd
0000             95   DADC           DATA 0xa4
0000             96   DADI           DATA 0xa5
0000             97   DADL           DATA 0xac
0000             98   DADH           DATA 0xad
0000             99   CCON           DATA 0xd8
0000            100   CMOD           DATA 0xd9
0000            101   CL             DATA 0xe9
0000            102   CH             DATA 0xf9
0000            103   CCAPM0         DATA 0xda
0000            104   CCAPM1         DATA 0xdb
0000            105   CCAPM2         DATA 0xdc
0000            106   CCAPM3         DATA 0xdd
0000            107   CCAPM4         DATA 0xde
0000            108   CCAP0H         DATA 0xfa
0000            109   CCAP1H         DATA 0xfb
0000            110   CCAP2H         DATA 0xfc
0000            111   CCAP3H         DATA 0xfd
0000            112   CCAP4H         DATA 0xfe
0000            113   CCAP0L         DATA 0xea
0000            114   CCAP1L         DATA 0xeb
0000            115   CCAP2L         DATA 0xec
0000            116   CCAP3L         DATA 0xed
0000            117   CCAP4L         DATA 0xee
0000            118   ;--------------------------------------------------------
0000            119   ; special function bits
0000            120   ;--------------------------------------------------------
0000            121   P              BIT 0xd0
0000            122   F1             BIT 0xd1
0000            123   OV             BIT 0xd2
0000            124   RS0            BIT 0xd3
0000            125   RS1            BIT 0xd4
0000            126   F0             BIT 0xd5
0000            127   AC             BIT 0xd6
0000            128   CY             BIT 0xd7
0000            129   EX0            BIT 0xa8
0000            130   ET0            BIT 0xa9
0000            131   EX1            BIT 0xaa
0000            132   ET1            BIT 0xab
0000            133   ES             BIT 0xac
0000            134   ET2            BIT 0xad
0000            135   EC             BIT 0xae
0000            136   EA             BIT 0xaf
0000            137   PX0            BIT 0xb8
0000            138   PT0            BIT 0xb9
0000            139   PX1            BIT 0xba
0000            140   PT1            BIT 0xbb
0000            141   PS             BIT 0xbc
0000            142   PT2            BIT 0xbd
0000            143   IP0D           BIT 0xbf
0000            144   PPCL           BIT 0xbe
0000            145   PT2L           BIT 0xbd
0000            146   PLS            BIT 0xbc
0000            147   PT1L           BIT 0xbb
0000            148   PX1L           BIT 0xba
0000            149   PT0L           BIT 0xb9
0000            150   PX0L           BIT 0xb8
0000            151   RXD            BIT 0xb0
0000            152   TXD            BIT 0xb1
0000            153   INT0           BIT 0xb2
0000            154   INT1           BIT 0xb3
0000            155   T0             BIT 0xb4
0000            156   T1             BIT 0xb5
0000            157   WR             BIT 0xb6
0000            158   RD             BIT 0xb7
0000            159   RI             BIT 0x98
0000            160   TI             BIT 0x99
0000            161   RB8            BIT 0x9a
0000            162   TB8            BIT 0x9b
0000            163   REN            BIT 0x9c
0000            164   SM2            BIT 0x9d
0000            165   SM1            BIT 0x9e
0000            166   SM0            BIT 0x9f
0000            167   IT0            BIT 0x88
0000            168   IE0            BIT 0x89
0000            169   IT1            BIT 0x8a
0000            170   IE1            BIT 0x8b
0000            171   TR0            BIT 0x8c
0000            172   TF0            BIT 0x8d
0000            173   TR1            BIT 0x8e
0000            174   TF1            BIT 0x8f
0000            175   CP_RL2         BIT 0xc8
0000            176   C_T2           BIT 0xc9
0000            177   TR2            BIT 0xca
0000            178   EXEN2          BIT 0xcb
0000            179   TCLK           BIT 0xcc
0000            180   RCLK           BIT 0xcd
0000            181   EXF2           BIT 0xce
0000            182   TF2            BIT 0xcf
0000            183   CF             BIT 0xdf
0000            184   CR             BIT 0xde
0000            185   CCF4           BIT 0xdc
0000            186   CCF3           BIT 0xdb
0000            187   CCF2           BIT 0xda
0000            188   CCF1           BIT 0xd9
0000            189   CCF0           BIT 0xd8
0000              3   
0000              4   ; There is a couple of typos in MODLP51 in the definition of the timer 0/1 reload
0000              5   ; special function registers (SFRs), so:
0000              6   
0000              7   TIMER0_RELOAD_L DATA 0xf2
0000              8   TIMER1_RELOAD_L DATA 0xf3
0000              9   TIMER0_RELOAD_H DATA 0xf4
0000             10   TIMER1_RELOAD_H DATA 0xf5
0000             11   
0000             12   CKCON0 DATA 0x8f
0000             13   
0000             14   CLK           EQU 22118400 ; Microcontroller system crystal frequency in Hz
0000             15   TIMER0_RATE   EQU 4096     ; 2048Hz squarewave (peak amplitude of CEM-1203 speaker)
0000             16   TIMER0_RELOAD EQU ((65536-(CLK/TIMER0_RATE)))
0000             17   TIMER2_RATE   EQU 1000     ; 1000Hz, for a timer tick of 1ms
0000             18   TIMER2_RELOAD EQU ((65536-(CLK/TIMER2_RATE)))
0000             19   
0000             20   DUTY_0    EQU 0
0000             21   DUTY_20   EQU 51   ;256 * 0.2
0000             22   DUTY_50   EQU 128  ;256 * 0.5
0000             23   DUTY_80   EQU 204  ;256 * 0.8
0000             24   DUTY_100  EQU 255
0000             25   
0000             26   bpm equ 160
0000             27   ms_per_beat equ ((60000/bpm) / 2)
0000             28   
0000             29   org 0x0000
0000 0206D2      30      ljmp MainProgram
0003             31   
0003             32   ; External interrupt 0 vector (not used in this code)
0003             33   org 0x0003
0003 32          34            reti
0004             35   
0004             36   ; Timer/Counter 0 overflow interrupt vector
000B             37   org 0x000B
000B 32          38            reti
000C             39   
000C             40   ; External interrupt 1 vector (not used in this code)
0013             41   org 0x0013
0013 32          42            reti
0014             43   
0014             44   ; Timer/Counter 1 overflow interrupt vector (not used in this code)
001B             45   org 0x001B
001B 32          46            reti
001C             47   
001C             48   ; Serial port receive/transmit interrupt vector (not used in this code)
0023             49   org 0x0023 
0023 32          50            reti
0024             51            
0024             52   ; Timer/Counter 2 overflow interrupt vector
002B             53   org 0x002B
002B 0203B9      54            ljmp Timer2_ISR
002E             55   
002E             56   ON_OFF EQU P0.0
002E             57   ;   FREQ          TRH1(LIN)
002E             58   ; C 261.63hz         
002E             59   ; D 293.66hz
002E             60   ; E 329.63hz     
002E             61   ; F 349.23hz        8.59
002E             62   ; G 392.00hz       35.59
002E             63   ; A 440.00hz       59.63
002E             64   ; B 493.88hz       81.03
002E             65   ; C 523.25hz       90.87
002E             66   ; D 587.33hz      108.89
002E             67   ; E 659.25hz      124.94
002E             68   ; F 698.46hz      132.29
002E             69   ; G 783.99hz      146.21
002E             70   ; A 880.00hz      157.81
002E             71   ; B 987.77hz      168.53
002E             72   ; C 1046.50hz     173.43
002E             73   ; D 1174.66hz     182.44
002E             74   ; E 1318.51hz     190.47
002E             75   ; F 1396.91hz     194.15 
002E             76   ; G 1567.98hz     200.89
002E             77   ; A 1760.00hz     206.90
002E             78   ; B 1975.53hz     212.26
002E             79   ; C 2093.00hz     214.72
002E             80   ; D 2349.32hz     219.22
002E             81   ; E 2637.02hz     223.24
002E             82   ; F 2793.83hz     225.07
002E             83   ; G 3135.96hz     228.45
002E             84   ; A 3520.00hz     231.45
002E             85   ; B 3951.07hz     234.13
002E             86   ; C 4186.01hz     235.36
002E             87   ; D 4698.63hz     237.61
002E             88   ; E 5274.04hz     239.61
002E             89   ; F 5587.65hz      240.53
002E             90   
002E             91   midi_F0 equ 9   ; state 0
002E             92   midi_G0 equ 36  ; state 1
002E             93   midi_A0 equ 60  ; state 2
002E             94   midi_B0 equ 81  ; state 3
002E             95   midi_C1 equ 91  ; state 4
002E             96   midi_D1 equ 109 ; state 5
002E             97   midi_E1 equ 125 ; state 6
002E             98   midi_F1 equ 132 ; state 7
002E             99   midi_G1 equ 146 ; state 8
002E            100   midi_A1 equ 158 ; state 9
002E            101   midi_B1 equ 169 ; state 10
002E            102   midi_C2 equ 173 ; state 11
002E            103   midi_D2 equ 182 ; state 12
002E            104   midi_E2 equ 190 ; state 13
002E            105   midi_F2 equ 194 ; state 14
002E            106   midi_G2 equ 201 ; state 15
002E            107   midi_A2 equ 207 ; state 16
002E            108   midi_B2 equ 212 ; state 17
002E            109   midi_C3 equ 215 ; state 18
002E            110   midi_D3 equ 219 ; state 19
002E            111   midi_E3 equ 223 ; state 20
002E            112   midi_F3 equ 225 ; state 21
002E            113   midi_G3 equ 228 ; state 22
002E            114   midi_A3 equ 231 ; state 23
002E            115   midi_B3 equ 234 ; state 24
002E            116   midi_C4 equ 235 ; state 25
002E            117   midi_D4 equ 238 ; state 26
002E            118   midi_E4 equ 240 ; state 27
002E            119   midi_F4 equ 241 ; state 28
002E            120   
002E            121   midi_D1S equ 117
002E            122   midi_A1S equ 163
002E            123   midi_D2S equ 187
002E            124   
002E            125   
002E            126   
002E            127   
002E            128            
0030            129   DSEG at 0x30
0030            130   Count1ms:      ds 2 ; Used to determine when half second has passed
0032            131   x:             ds 4
0036            132   y:             ds 4
003A            133   bcd:           ds 5
003F            134   ;Oscillator
003F            135   duty:          ds 1
0040            136   ;midi
0040            137   freq_value:              ds 1
0041            138   midi_note_state:         ds 1
0042            139   musical_notes:           ds 31
0061            140   seq_count:               ds 1
0062            141   seq_size:                ds 1
0063            142   
0063            143   
0000            144   BSEG
0000            145   direction: dbit 1
0001            146   mf: dbit 1
0002            147   mute: dbit 1
0003            148   midi_trigger: dbit 1
0004            149   
002E            150   CSEG
002E            151   
002E            152   ; For the LCD
002E            153   LCD_RS equ P1.1
002E            154   LCD_RW equ P1.2
002E            155   LCD_E  equ P1.3
002E            156   LCD_D4 equ P3.2
002E            157   LCD_D5 equ P3.3
002E            158   LCD_D6 equ P3.4
002E            159   LCD_D7 equ P3.6
002E            160   
002E 0B0D0B0F   161   midi_seq: db 0x0bh, 0x0dh, 0x0bh, 0x0fh, 0x0bh, 0x0dh, 0x0bh, 0x0fh, 0x0ah, 0x0dh, 0x0ah, 0x0fh, 0x0ah, 0x0dh, 0x0ah, 0x13, 0x0ah, 0x0dh, 0x0ah, 0x0fh, 0x0ah, 0x0dh, 0x0ah, 0x0fh, 0x0ah, 0x0dh, 0x0ah, 0x0fh, 0x0ah, 0x0dh, 0x0ah, 0x13, 0
     0B0D0B0F
     0A0D0A0F
     0A0D0A13
     0A0D0A0F
     0A0D0A0F
     0A0D0A0F
     0A0D0A13
     00
004F            162               ;            -             -             -             -             -             -             -            --     -      -             -             -             -             -             -             -            --
004F            163   
004F            164   ;midi_seq: db 0x07, 0x08, 0x05, 0x07, 0x06, 0x0c, 0x0f, 0x0f, 0x07, 0x0b, 0x0d
004F            165   
                167   	$LIST
00FD            169   
                546   $LIST
                171   $LIST
036D            173            
036D            174   ;---------------------------------;
036D            175   ; Routine to initialize the ISR   ;
036D            176   ; for timer 1                     ; 
036D            177   ;---------------------------------;
036D            178   Timer1_Init:
036D E58F       179            mov a, CKCON0
036F 54FB       180            anl a, #11111011B
0371 4404       181            orl a, #00000100B ; TK1 = 1 to allow TPs + 1
0373 F58F       182            mov CKCON0, a
0375            183            
0375 E5AE       184            mov a, CLKREG
0377 5400       185            anl a, #00000000B
0379 4450       186            orl a, #01010000B      ;TPS1 = 5
037B F5AE       187            mov CLKREG, a
037D            188   
037D E589       189            mov a, TMOD
037F 540F       190            anl a, #00001111B       ;Clears timer 1 settings but keeps timer 0 settings
0381 4410       191            orl a, #00010000B       ;Gate = 0, TC1 = 0, mode = 01 (mode 1)
0383 F589       192            mov TMOD, a
0385            193            
0385 E591       194            mov a, TCONB            ;load TCONB for PWM settings
0387 5400       195            anl a, #00000000B       ;clear TCONB
0389 4480       196            orl a, #10000000B       ;Set PWM1 = 1, PWM0 = 0, PRESC1 = 000, PRESC0 = 000
038B F591       197            mov TCONB, a
038D            198            
038D 758D00     199            mov TH1, #0             ;Current count value
0390 758B00     200            mov TL1, #0             ;Linear Prescaling
0393            201            
0393 7464       202            mov a, #100
0395 F53F       203            mov duty, a
0397 F5F5       204            mov TIMER1_RELOAD_H, a ;Duty cycle percentage. Replace this value to change the duty cycle
0399 E540       205            mov a, freq_value
039B F5F3       206            mov TIMER1_RELOAD_L, a      ;Frequency scaling/adjust f_out = f_sys/(256 * (256 - TL))
039D            207            
039D C28E       208            clr TR1
039F 32         209            reti
03A0            210            
03A0            211   ;---------------------------------;
03A0            212   ; Routine to initialize the ISR   ;
03A0            213   ; for timer 2                     ;
03A0            214   ;---------------------------------;
03A0            215   Timer2_Init:
03A0 75C800     216            mov T2CON, #0 ; Stop timer/counter.  Autoreload mode.
03A3 75CDA9     217            mov TH2, #high(TIMER2_RELOAD)
03A6 75CC9A     218            mov TL2, #low(TIMER2_RELOAD)
03A9            219            ; Set the reload value
03A9 75CBA9     220            mov RCAP2H, #high(TIMER2_RELOAD)
03AC 75CA9A     221            mov RCAP2L, #low(TIMER2_RELOAD)
03AF            222            ; Init One millisecond interrupt counter.  It is a 16-bit variable made with two 8-bit parts
03AF E4         223            clr a
03B0 F530       224            mov Count1ms+0, a
03B2 F531       225            mov Count1ms+1, a
03B4            226            ; Enable the timer and interrupts
03B4 D2AD       227       setb ET2  ; Enable timer 2 interrupt
03B6 D2CA       228       setb TR2  ; Enable timer 2
03B8 22         229            ret
03B9            230   
03B9            231   ;---------------------------------;
03B9            232   ; ISR for timer 2                 ;
03B9            233   ;---------------------------------;
03B9            234   Timer2_ISR:
03B9 C2CF       235            clr TF2  ; Timer 2 doesn't clear TF2 automatically. Do it in ISR
03BB            236   
03BB            237            ; The two registers used in the ISR must be saved in the stack
03BB C0E0       238            push acc
03BD C0D0       239            push psw
03BF            240   
03BF 0530       241            inc Count1ms+0    ; Increment the low 8-bits first
03C1 E530       242            mov a, Count1ms+0 ; If the low 8-bits overflow, then increment high 8-bits
03C3 7002       243            jnz Inc_Done
03C5 0531       244            inc Count1ms+1
03C7            245            
03C7            246            Inc_Done:
03C7            247            ; Check if a second has passed
03C7            248   
03C7 E530       249            mov a, Count1ms+0
03C9 B4BB0E     250            cjne a, #low(ms_per_beat), Timer2_ISR_done ; Warning: this instruction changes the carry flag!
03CC E531       251            mov a, Count1ms+1
03CE B40009     252            cjne a, #high(ms_per_beat), Timer2_ISR_done
03D1 753000     253            mov Count1ms+0, #0
03D4 753100     254            mov Count1ms+1, #0
03D7            255            
03D7 1203E8     256            lcall next_midi_note_state
03DA            257   
03DA            258   Timer2_ISR_done:
03DA            259   
03DA D0D0       260            pop psw
03DC D0E0       261            pop acc
03DE 32         262            reti
03DF            263            
03DF            264   Delay:
03DF 79DE       265            mov R1, #222
03E1 78A6       266       mov R0, #166
03E3 D8FE       267       djnz R0, $   ; 3 cycles->3*45.21123ns*166=22.51519us
03E5 D9FA       268       djnz R1, $-4 ; 22.51519us*222=4.998ms
03E7 22         269       ret
03E8            270       
03E8            271   next_midi_note_state: ;{
03E8 90002E     272            mov dptr, #midi_seq
03EB            273            
03EB E561       274            mov a, seq_count
03ED 93         275            movc a, @a+dptr
03EE F541       276            mov midi_note_state, a
03F0            277            
03F0 E561       278            mov a, seq_count
03F2 2401       279            add a, #1
03F4 F561       280            mov seq_count, a
03F6 B56203     281            cjne a, seq_size, end_note_update
03F9 756100     282            mov seq_count, #0
03FC            283   end_note_update:
03FC            284            
03FC D203       285            setb midi_trigger
03FE            286            
03FE 22         287            ret
03FF            288   ;}
03FF            289   
                290   Left_blank mac
                291   	mov a, %0
                292   	anl a, #0xf0
                293   	swap a
                294   	jz Left_blank_%M_a
                295   	ljmp %1
                296   Left_blank_%M_a:
                297   	Display_char(#' ')
                298   	mov a, %0
                299   	anl a, #0x0f
                300   	jz Left_blank_%M_b
                301   	ljmp %1
                302   Left_blank_%M_b:
                303   	Display_char(#' ')
                304   endmac
03FF            305      
03FF            306   ; Sends 10-digit BCD number in bcd to the LCD 
03FF            307   Display_10_digit_BCD: ;{
03FF C0E0       308            push acc
0401 7407       308            mov a, #7
0403 14         308            dec a
0404 1200E0     308            lcall ?Set_Cursor_2 ; Select column and row
0407 D0E0       308            pop acc
0409 C000       309            push ar0
040B A83E       309            mov r0, bcd+4
040D 1200E7     309            lcall ?Display_BCD
0410 D000       309            pop ar0
0412 C000       310            push ar0
0414 A83D       310            mov r0, bcd+3
0416 1200E7     310            lcall ?Display_BCD
0419 D000       310            pop ar0
041B C000       311            push ar0
041D A83C       311            mov r0, bcd+2
041F 1200E7     311            lcall ?Display_BCD
0422 D000       311            pop ar0
0424 C000       312            push ar0
0426 A83B       312            mov r0, bcd+1
0428 1200E7     312            lcall ?Display_BCD
042B D000       312            pop ar0
042D C000       313            push ar0
042F A83A       313            mov r0, bcd+0
0431 1200E7     313            lcall ?Display_BCD
0434 D000       313            pop ar0
0436            314            ; Replace all the zeros to the left with blanks
0436 C0E0       315            push acc
0438 7407       315            mov a, #7
043A 14         315            dec a
043B 1200E0     315            lcall ?Set_Cursor_2 ; Select column and row
043E D0E0       315            pop acc
0440 E53E       316            mov a, bcd+4
0442 54F0       316            anl a, #0xf0
0444 C4         316            swap a
0445 6003       316            jz Left_blank_15_a
0447 0204E4     316            ljmp skip_blank
044A            316   Left_blank_15_a:
044A C0E0       316            push acc
044C 7420       316            mov a, #' '
044E 12009F     316            lcall ?WriteData
0451 D0E0       316            pop acc
0453 E53E       316            mov a, bcd+4
0455 540F       316            anl a, #0x0f
0457 6003       316            jz Left_blank_15_b
0459 0204E4     316            ljmp skip_blank
045C            316   Left_blank_15_b:
045C C0E0       316            push acc
045E 7420       316            mov a, #' '
0460 12009F     316            lcall ?WriteData
0463 D0E0       316            pop acc
0465 E53D       317            mov a, bcd+3
0467 54F0       317            anl a, #0xf0
0469 C4         317            swap a
046A 6003       317            jz Left_blank_18_a
046C 0204E4     317            ljmp skip_blank
046F            317   Left_blank_18_a:
046F C0E0       317            push acc
0471 7420       317            mov a, #' '
0473 12009F     317            lcall ?WriteData
0476 D0E0       317            pop acc
0478 E53D       317            mov a, bcd+3
047A 540F       317            anl a, #0x0f
047C 6003       317            jz Left_blank_18_b
047E 0204E4     317            ljmp skip_blank
0481            317   Left_blank_18_b:
0481 C0E0       317            push acc
0483 7420       317            mov a, #' '
0485 12009F     317            lcall ?WriteData
0488 D0E0       317            pop acc
048A E53C       318            mov a, bcd+2
048C 54F0       318            anl a, #0xf0
048E C4         318            swap a
048F 6003       318            jz Left_blank_21_a
0491 0204E4     318            ljmp skip_blank
0494            318   Left_blank_21_a:
0494 C0E0       318            push acc
0496 7420       318            mov a, #' '
0498 12009F     318            lcall ?WriteData
049B D0E0       318            pop acc
049D E53C       318            mov a, bcd+2
049F 540F       318            anl a, #0x0f
04A1 6003       318            jz Left_blank_21_b
04A3 0204E4     318            ljmp skip_blank
04A6            318   Left_blank_21_b:
04A6 C0E0       318            push acc
04A8 7420       318            mov a, #' '
04AA 12009F     318            lcall ?WriteData
04AD D0E0       318            pop acc
04AF E53B       319            mov a, bcd+1
04B1 54F0       319            anl a, #0xf0
04B3 C4         319            swap a
04B4 6003       319            jz Left_blank_24_a
04B6 0204E4     319            ljmp skip_blank
04B9            319   Left_blank_24_a:
04B9 C0E0       319            push acc
04BB 7420       319            mov a, #' '
04BD 12009F     319            lcall ?WriteData
04C0 D0E0       319            pop acc
04C2 E53B       319            mov a, bcd+1
04C4 540F       319            anl a, #0x0f
04C6 6003       319            jz Left_blank_24_b
04C8 0204E4     319            ljmp skip_blank
04CB            319   Left_blank_24_b:
04CB C0E0       319            push acc
04CD 7420       319            mov a, #' '
04CF 12009F     319            lcall ?WriteData
04D2 D0E0       319            pop acc
04D4 E53A       320            mov a, bcd+0
04D6 54F0       321            anl a, #0f0h
04D8 C4         322            swap a
04D9 7009       323            jnz skip_blank
04DB C0E0       324            push acc
04DD 7420       324            mov a, #' '
04DF 12009F     324            lcall ?WriteData
04E2 D0E0       324            pop acc
04E4            325   skip_blank:
04E4 22         326            ret
04E5            327   ;}
04E5            328            
04E5            329   display_milli:
04E5 853032     330            mov x+0, Count1ms+0
04E8 853133     331            mov x+1, Count1ms+1
04EB 753400     332            mov x+2, #0
04EE 753500     333            mov x+3, #0
04F1            334            
04F1 1200FD     335            lcall hex2bcd
04F4 1203FF     336            lcall Display_10_digit_BCD
04F7 22         337            ret
04F8            338            
04F8            339   display_state:
04F8 854132     340            mov x+0, midi_note_state+0
04FB 753300     341            mov X+1, #0
04FE 753400     342            mov x+2, #0
0501 753500     343            mov x+3, #0
0504            344            
0504 1200FD     345            lcall hex2bcd
0507 1203FF     346            lcall Display_10_digit_BCD
050A 22         347            ret
050B            348            
050B            349   load_midi_notes:
050B 754209     350            mov musical_notes+0, #midi_F0  ;0x00
050E 754324     351            mov musical_notes+1, #midi_G0  ;0x01
0511 75443C     352            mov musical_notes+2, #midi_A0  ;0x02
0514 754551     353            mov musical_notes+3, #midi_B0  ;0x03 
0517 75465B     354            mov musical_notes+4, #midi_C1  ;0x04 
051A 75476D     355            mov musical_notes+5, #midi_D1  ;0x05 
051D 75487D     356            mov musical_notes+6, #midi_E1  ;0x06
0520 754984     357            mov musical_notes+7, #midi_F1  ;0x07 
0523 754A92     358            mov musical_notes+8, #midi_G1  ;0x08
0526 754B9E     359            mov musical_notes+9, #midi_A1  ;0x09
0529 754CA9     360            mov musical_notes+10, #midi_B1 ;0x0a
052C 754DAD     361            mov musical_notes+11, #midi_C2 ;0x0b 
052F 754EB6     362            mov musical_notes+12, #midi_D2 ;0x0c 
0532 754FBE     363            mov musical_notes+13, #midi_E2 ;0x0d
0535 7550C2     364            mov musical_notes+14, #midi_F2 ;0x0e 
0538 7551C9     365            mov musical_notes+15, #midi_G2 ;0x0f
053B 7552CF     366            mov musical_notes+16, #midi_A2 ;0x10
053E 7553D4     367            mov musical_notes+17, #midi_B2 ;0x11
0541 7554D7     368            mov musical_notes+18, #midi_C3 ;0x12
0544 7555DB     369            mov musical_notes+19, #midi_D3 ;0x13
0547 7556DF     370            mov musical_notes+20, #midi_E3 ;0x14
054A 7557E1     371            mov musical_notes+21, #midi_F3 ;0x15 
054D 7558E4     372            mov musical_notes+22, #midi_G3 ;0x16
0550 7559E7     373            mov musical_notes+23, #midi_A3 ;0x17 
0553 755AEA     374            mov musical_notes+24, #midi_B3 ;0x18
0556 755BEB     375            mov musical_notes+25, #midi_C4 ;0x19
0559 755CEE     376            mov musical_notes+26, #midi_D4 ;0x1a
055C 755DF0     377            mov musical_notes+27, #midi_E4 ;0x1b
055F 755EF1     378            mov musical_notes+28, #midi_F4 ;0x1c
0562            379            ; sharps
0562 755F75     380            mov musical_notes+29, #midi_D1S ; 0x1d
0565 7560A3     381            mov musical_notes+30, #midi_A1S ; 0x1e
0568 7561BB     382            mov musical_notes+31, #midi_D2S ; 0x1f
056B            383            
056B 22         384            ret
056C            385            
056C            386   midi_note_state_machine:
056C 1204F8     387            lcall display_state
056F E541       388            mov a, midi_note_state
0571            389   midi_note_state0:
0571 B40007     390            cjne a, #0, midi_note_state1
0574 D28E       391            setb TR1
0576 E542       392            mov a, musical_notes+0
0578 0206C4     393            ljmp midi_note_end_state_machine
057B            394   midi_note_state1:
057B B40107     395            cjne a, #1, midi_note_state2
057E D28E       396            setb TR1
0580 E543       397            mov a, musical_notes+1
0582 0206C4     398            ljmp midi_note_end_state_machine
0585            399   midi_note_state2:
0585 B40207     400            cjne a, #2, midi_note_state3
0588 D28E       401            setb TR1
058A E544       402            mov a, musical_notes+2
058C 0206C4     403            ljmp midi_note_end_state_machine
058F            404   midi_note_state3:
058F B40307     405            cjne a, #3, midi_note_state4
0592 D28E       406            setb TR1
0594 E545       407            mov a, musical_notes+3
0596 0206C4     408            ljmp midi_note_end_state_machine
0599            409   midi_note_state4:
0599 B40409     410            cjne a, #4, midi_note_state5
059C D28E       411            setb TR1
059E E546       412            mov a, musical_notes+4
05A0 0206C4     413            ljmp midi_note_end_state_machine
05A3 D28E       414            setb TR1
05A5            415   midi_note_state5:
05A5 B40507     416            cjne a, #5, midi_note_state6
05A8 D28E       417            setb TR1
05AA E547       418            mov a, musical_notes+5
05AC 0206C4     419            ljmp midi_note_end_state_machine
05AF            420   midi_note_state6:
05AF B40607     421            cjne a, #6, midi_note_state7
05B2 D28E       422            setb TR1
05B4 E548       423            mov a, musical_notes+6
05B6 0206C4     424            ljmp midi_note_end_state_machine
05B9            425   midi_note_state7:
05B9 B40707     426            cjne a, #7, midi_note_state8
05BC D28E       427            setb TR1
05BE E549       428            mov a, musical_notes+7
05C0 0206C4     429            ljmp midi_note_end_state_machine
05C3            430   midi_note_state8:
05C3 B40807     431            cjne a, #8, midi_note_state9
05C6 D28E       432            setb TR1
05C8 E54A       433            mov a, musical_notes+8
05CA 0206C4     434            ljmp midi_note_end_state_machine
05CD            435   midi_note_state9:
05CD B40907     436            cjne a, #9, midi_note_state10
05D0 D28E       437            setb TR1
05D2 E54B       438            mov a, musical_notes+9
05D4 0206C4     439            ljmp midi_note_end_state_machine
05D7            440   midi_note_state10:
05D7 B40A07     441            cjne a, #10, midi_note_state11
05DA D28E       442            setb TR1
05DC E54C       443            mov a, musical_notes+10
05DE 0206C4     444            ljmp midi_note_end_state_machine
05E1            445   midi_note_state11:
05E1 B40B09     446            cjne a, #11, midi_note_state12
05E4 D28E       447            setb TR1
05E6 E54D       448            mov a, musical_notes+11
05E8 0206C4     449            ljmp midi_note_end_state_machine
05EB D28E       450            setb TR1
05ED            451   midi_note_state12:
05ED B40C07     452            cjne a, #12, midi_note_state13
05F0 D28E       453            setb TR1
05F2 E54E       454            mov a, musical_notes+12
05F4 0206C4     455            ljmp midi_note_end_state_machine
05F7            456   midi_note_state13:
05F7 B40D07     457            cjne a, #13, midi_note_state14
05FA D28E       458            setb TR1
05FC E54F       459            mov a, musical_notes+13
05FE 0206C4     460            ljmp midi_note_end_state_machine
0601            461   midi_note_state14:
0601 B40E07     462            cjne a, #14, midi_note_state15
0604 D28E       463            setb TR1
0606 E550       464            mov a, musical_notes+14
0608 0206C4     465            ljmp midi_note_end_state_machine
060B            466   midi_note_state15:
060B B40F07     467            cjne a, #15, midi_note_state16
060E D28E       468            setb TR1
0610 E551       469            mov a, musical_notes+15
0612 0206C4     470            ljmp midi_note_end_state_machine
0615            471   midi_note_state16:
0615 B41007     472            cjne a, #16, midi_note_state17
0618 D28E       473            setb TR1
061A E552       474            mov a, musical_notes+16
061C 0206C4     475            ljmp midi_note_end_state_machine
061F            476   midi_note_state17:
061F B41107     477            cjne a, #17, midi_note_state18
0622 D28E       478            setb TR1
0624 E553       479            mov a, musical_notes+17
0626 0206C4     480            ljmp midi_note_end_state_machine
0629            481   midi_note_state18:
0629 B41207     482            cjne a, #18, midi_note_state19
062C D28E       483            setb TR1
062E E554       484            mov a, musical_notes+18
0630 0206C4     485            ljmp midi_note_end_state_machine
0633            486   midi_note_state19:
0633 B41307     487            cjne a, #19, midi_note_state20
0636 D28E       488            setb TR1
0638 E555       489            mov a, musical_notes+19
063A 0206C4     490            ljmp midi_note_end_state_machine
063D            491   midi_note_state20:
063D B41407     492            cjne a, #20, midi_note_state21
0640 D28E       493            setb TR1
0642 E556       494            mov a, musical_notes+20
0644 0206C4     495            ljmp midi_note_end_state_machine
0647            496   midi_note_state21:
0647 B41509     497            cjne a, #21, midi_note_state22
064A D28E       498            setb TR1
064C E557       499            mov a, musical_notes+21
064E 0206C4     500            ljmp midi_note_end_state_machine
0651 D28E       501            setb TR1
0653            502   midi_note_state22:
0653 B41607     503            cjne a, #22, midi_note_state23
0656 D28E       504            setb TR1
0658 E558       505            mov a, musical_notes+22
065A 0206C4     506            ljmp midi_note_end_state_machine
065D            507   midi_note_state23:
065D B41707     508            cjne a, #23, midi_note_state24
0660 D28E       509            setb TR1
0662 E559       510            mov a, musical_notes+23
0664 0206C4     511            ljmp midi_note_end_state_machine
0667            512   midi_note_state24:
0667 B41807     513            cjne a, #24, midi_note_state25
066A D28E       514            setb TR1
066C E55A       515            mov a, musical_notes+24
066E 0206C4     516            ljmp midi_note_end_state_machine
0671            517   midi_note_state25:
0671 B41907     518            cjne a, #25, midi_note_state26
0674 D28E       519            setb TR1
0676 E55B       520            mov a, musical_notes+25
0678 0206C4     521            ljmp midi_note_end_state_machine
067B            522   midi_note_state26:
067B B41A07     523            cjne a, #26, midi_note_state27
067E D28E       524            setb TR1
0680 E55C       525            mov a, musical_notes+26
0682 0206C4     526            ljmp midi_note_end_state_machine
0685            527   midi_note_state27:
0685 B41B07     528            cjne a, #27, midi_note_state28
0688 D28E       529            setb TR1
068A E55D       530            mov a, musical_notes+27
068C 0206C4     531            ljmp midi_note_end_state_machine
068F            532   midi_note_state28:
068F B41C27     533            cjne a, #28, midi_note_state_off
0692 D28E       534            setb TR1
0694 E55E       535            mov a, musical_notes+28
0696 0206C4     536            ljmp midi_note_end_state_machine
0699            537   midi_note_state29:
0699 B41D07     538            cjne a, #29, midi_note_state30
069C D28E       539            setb TR1
069E E55F       540            mov a, musical_notes+29
06A0 0206C4     541            ljmp midi_note_end_state_machine
06A3            542   midi_note_state30:
06A3 B41E07     543            cjne a, #30, midi_note_state31
06A6 D28E       544            setb TR1
06A8 E560       545            mov a, musical_notes+30
06AA 0206C4     546            ljmp midi_note_end_state_machine
06AD            547   midi_note_state31:
06AD B41F09     548            cjne a, #31, midi_note_state_off
06B0 D28E       549            setb TR1
06B2 E561       550            mov a, musical_notes+31
06B4 0206C4     551            ljmp midi_note_end_state_machine
06B7 D28E       552            setb TR1
06B9            553   midi_note_state_off:
06B9 B42005     554            cjne a, #32, midi_note_default_state
06BC C28E       555            clr TR1
06BE 0206C4     556            ljmp midi_note_end_state_machine
06C1            557   midi_note_default_state:
06C1 754100     558            mov midi_note_state, #0
06C4            559   midi_note_end_state_machine:     
06C4 F540       560            mov freq_value, a
06C6 F5F3       561            mov TIMER1_RELOAD_L, a
06C8 C203       562            clr midi_trigger
06CA            563            
06CA 22         564            ret
06CB            565            
06CB            566   play_midi_note:
06CB 200203     567            jb mute, end_midi_sm
06CE 12056C     568            lcall midi_note_state_machine
06D1            569   end_midi_sm:
06D1 22         570            ret
06D2            571            
06D2            572   MainProgram:
06D2 75817F     573       mov SP, #7FH ; Set the stack pointer to the begining of idata
06D5 754000     574       mov freq_value, #0
06D8 D200       575       setb direction
06DA 12036D     576       lcall Timer1_Init
06DD 1203A0     577       lcall Timer2_Init
06E0 1200A9     578       lcall LCD_4BIT
06E3 12050B     579       lcall load_midi_notes
06E6            580       
06E6 C202       581       clr mute
06E8 C203       582       clr midi_trigger
06EA 75E600     583       mov P0M0, #0
06ED 75E700     584       mov P0M1, #0
06F0            585       
06F0 D2AF       586       setb EA   ; Enable Global interrupts
06F2            587       
06F2 756100     588       mov seq_count, #0
06F5 756220     589       mov seq_size, #32
06F8            590   forever:
06F8            591   
06F8 208010     592            jb ON_OFF, midi
06FB 1203DF     593            lcall Delay
06FE 20800A     594            jb ON_OFF, midi
0701 3080FD     595            jnb ON_OFF, $
0704 B202       596            cpl mute
0706 300202     597            jnb mute, midi
0709 C28E       598            clr TR1 
070B            599            
070B            600   midi:
070B 200206     601            jb mute, midi_end
070E 300303     602            jnb midi_trigger, midi_end
0711 1206CB     603            lcall play_midi_note
0714            604   midi_end:
0714            605   
0714 80E2       606            sjmp forever
0716            607   en
